<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#F8FAFC">
    <meta name="apple-mobile-web-app-title" content="NunziaDiet">
    <title>NunziaDiet</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        :root {
            --bg: #F8FAFC;
            --card: #FFFFFF;
            --border: #E2E8F0;
            --accent: #5AC8FA;
            --accent-light: #E0F4FD;
            --text: #1E293B;
            --text-secondary: #94A3B8;
            --success: #34D399;
            --error: #F87171;
            --warning: #FBBF24;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 100px;
            -webkit-font-smoothing: antialiased;
        }

        .container { max-width: 420px; margin: 0 auto; padding: 16px; }

        .header {
            text-align: center;
            padding: 24px 0 16px;
        }
        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: var(--accent);
            letter-spacing: -0.5px;
        }

        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
        }

        .card-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .stats-row { display: flex; justify-content: space-around; text-align: center; }
        .stat { flex: 1; }
        .stat-value { font-size: 28px; font-weight: 600; color: var(--text); }
        .stat-label { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
        .stat-value.streak { color: var(--warning); }
        .stat-value.points { color: var(--accent); }

        .user-select { display: flex; gap: 12px; margin-bottom: 16px; }
        .user-btn {
            flex: 1;
            padding: 20px 16px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--card);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .user-btn:active { transform: scale(0.98); }
        .user-btn.active { border-color: var(--accent); background: var(--accent-light); }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--accent-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            color: var(--accent);
            overflow: hidden;
        }
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .input-group { margin-bottom: 14px; }
        .input-group label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
            background: var(--card);
        }
        .input-group input:focus { border-color: var(--accent); }

        .water-tracker {
            display: flex;
            justify-content: center;
            gap: 8px;
            align-items: center;
        }
        .water-drop {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        .water-drop.filled {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
        }
        .water-total {
            font-size: 14px;
            color: var(--text);
            font-weight: 500;
            margin-left: 8px;
            min-width: 40px;
        }

        .activity-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px;
            background: var(--bg);
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
        }
        .activity-toggle.active { background: var(--accent-light); }

        .toggle-switch {
            width: 48px;
            height: 28px;
            background: var(--border);
            border-radius: 14px;
            position: relative;
            transition: background 0.2s;
            flex-shrink: 0;
        }
        .toggle-switch.active { background: var(--accent); }
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .toggle-switch.active::after { transform: translateX(20px); }

        .meal-card {
            background: var(--card);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
        }
        .meal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .meal-time {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        .choice-group { margin-bottom: 12px; }
        .choice-label {
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 6px;
            font-weight: 500;
            letter-spacing: 0.3px;
        }
        .choice-buttons { display: flex; flex-wrap: wrap; gap: 6px; }
        .choice-btn {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--card);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .choice-btn:active { transform: scale(0.96); }
        .choice-btn.selected {
            border-color: var(--accent);
            background: var(--accent-light);
            color: var(--accent);
        }
        .choice-btn.small { padding: 6px 10px; font-size: 11px; }

        .meal-actions { display: flex; gap: 8px; margin-top: 12px; }
        .meal-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--card);
        }
        .meal-btn.ok { color: var(--success); border-color: var(--success); }
        .meal-btn.ok.active { background: var(--success); color: #fff; }
        .meal-btn.sgarro { color: var(--error); border-color: var(--error); }
        .meal-btn.sgarro.active { background: var(--error); color: #fff; }

        .btn-primary {
            width: 100%;
            padding: 14px;
            background: var(--accent);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
        }
        .btn-primary:active { transform: scale(0.98); opacity: 0.9; }

        .btn-secondary {
            width: 100%;
            padding: 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 10px;
        }

        .nav-tabs {
            display: flex;
            background: var(--card);
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
        }
        .nav-tab {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
        }
        .nav-tab.active { background: var(--accent); color: #fff; }

        .week-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            margin-bottom: 16px;
        }
        .week-day {
            text-align: center;
            padding: 10px 4px;
            background: var(--bg);
            border-radius: 8px;
        }
        .week-day-name { font-size: 10px; color: var(--text-secondary); margin-bottom: 4px; }
        .week-day-status { font-size: 16px; }
        .week-day.today {
            background: var(--accent-light);
            border: 1px solid var(--accent);
        }

        .progress-bar {
            height: 6px;
            background: var(--bg);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .level-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: var(--accent-light);
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            color: var(--accent);
            margin-top: 6px;
        }

        .motivation-box {
            background: var(--bg);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
            border: 1px solid var(--border);
            margin-top: 12px;
        }
        .motivation-box p {
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-secondary);
            font-style: italic;
        }

        .dietolog-card {
            background: var(--accent-light);
            border-color: var(--accent);
        }

        .hidden { display: none !important; }

        .badge-grid { display: flex; flex-wrap: wrap; gap: 6px; }
        .badge {
            padding: 6px 10px;
            background: var(--bg);
            border-radius: 16px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
            opacity: 0.4;
            border: 1px solid var(--border);
        }
        .badge.earned {
            background: var(--accent-light);
            border-color: var(--accent);
            opacity: 1;
        }

        .detail-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }
        .qty-note {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .photo-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            padding: 16px;
        }
        .photo-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--bg);
            border: 2px dashed var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .photo-preview:hover { border-color: var(--accent); }
        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .photo-preview-placeholder {
            font-size: 24px;
            color: var(--text-secondary);
        }
        .photo-upload input[type="file"] { display: none; }
        .photo-upload-text {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .profile-photo {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: var(--accent-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 600;
            color: var(--accent);
            overflow: hidden;
            margin: 0 auto 8px;
        }
        .profile-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>NunziaDiet</h1>
        </div>

        <!-- Screen: User Selection -->
        <div id="screen-select" class="screen">
            <div class="card">
                <div class="card-title">Chi sei?</div>
                <div class="user-select">
                    <button class="user-btn" onclick="selectUser('Paolo')" id="btn-paolo">
                        <div class="user-avatar" id="avatar-paolo">P</div>
                        <span>Paolo</span>
                    </button>
                    <button class="user-btn" onclick="selectUser('Flora')" id="btn-flora">
                        <div class="user-avatar" id="avatar-flora">F</div>
                        <span>Flora</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Screen: Setup -->
        <div id="screen-setup" class="screen hidden">
            <div class="card">
                <div class="card-title">Il tuo profilo</div>

                <div class="photo-upload">
                    <div class="photo-preview" onclick="document.getElementById('photo-input').click()">
                        <span class="photo-preview-placeholder" id="photo-placeholder">+</span>
                        <img id="photo-preview-img" class="hidden">
                    </div>
                    <input type="file" id="photo-input" accept="image/*" onchange="handlePhotoUpload(event)">
                    <span class="photo-upload-text">Tocca per aggiungere foto</span>
                </div>

                <div class="input-group">
                    <label>Data inizio dieta</label>
                    <input type="date" id="start-date">
                </div>
                <div class="input-group">
                    <label>Peso iniziale (kg)</label>
                    <input type="number" id="start-weight" step="0.1" placeholder="75.0">
                </div>
                <div class="input-group">
                    <label>Peso obiettivo (kg)</label>
                    <input type="number" id="goal-weight" step="0.1" placeholder="70.0">
                </div>
                <div class="input-group">
                    <label>Settimane target</label>
                    <input type="number" id="target-weeks" placeholder="8">
                </div>
                <button class="btn-primary" onclick="saveSetup()">Inizia</button>
            </div>
        </div>

        <!-- Screen: Dashboard -->
        <div id="screen-dashboard" class="screen hidden">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('daily')">Oggi</button>
                <button class="nav-tab" onclick="showTab('weekly')">Settimana</button>
                <button class="nav-tab" onclick="showTab('profile')">Profilo</button>
            </div>

            <!-- Tab: Daily -->
            <div id="tab-daily" class="tab-content">
                <div class="card">
                    <div class="stats-row">
                        <div class="stat">
                            <div class="stat-value" id="day-counter">1</div>
                            <div class="stat-label">Giorno</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value streak" id="streak-counter">0</div>
                            <div class="stat-label">Streak</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value points" id="points-counter">0</div>
                            <div class="stat-label">Punti</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Acqua - obiettivo 2L</div>
                    <div class="water-tracker" id="water-tracker"></div>
                </div>

                <div class="card">
                    <div class="card-title">Attivita fisica</div>
                    <div class="activity-toggle" id="activity-toggle" onclick="toggleActivity()">
                        <span>Hai fatto attivita oggi?</span>
                        <div class="toggle-switch" id="activity-switch"></div>
                    </div>
                </div>

                <div class="card-title" style="margin: 16px 0 10px;">Pasti</div>
                <div id="meals-container"></div>

                <button class="btn-primary" onclick="saveDay()" style="margin-top: 16px;">Salva giornata</button>
            </div>

            <!-- Tab: Weekly -->
            <div id="tab-weekly" class="tab-content hidden">
                <div class="card">
                    <div class="card-title">Questa settimana</div>
                    <div class="week-grid" id="week-grid"></div>
                    <div class="stats-row" style="margin-top: 12px;">
                        <div class="stat">
                            <div class="stat-value" style="color: var(--success);" id="week-ok">0</div>
                            <div class="stat-label">Giorni OK</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" style="color: var(--error);" id="week-sgarro">0</div>
                            <div class="stat-label">Sgarri</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="week-adherence">0%</div>
                            <div class="stat-label">Aderenza</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Progressi peso</div>
                    <div class="input-group">
                        <label>Peso attuale (kg)</label>
                        <input type="number" id="current-weight" step="0.1" onchange="updateWeight()">
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary);">
                        <span id="start-w-label">Inizio: --</span>
                        <span id="goal-w-label">Obiettivo: --</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="weight-progress" style="width: 0%"></div>
                    </div>
                    <p style="text-align: center; font-size: 13px; color: var(--text);" id="weight-diff">-- kg persi</p>
                </div>

                <div class="card dietolog-card">
                    <div class="card-title">Check Dietologo</div>
                    <div class="input-group">
                        <label>Data visita</label>
                        <input type="date" id="visit-date">
                    </div>
                    <div class="input-group">
                        <label>Esito</label>
                        <select id="visit-outcome">
                            <option value="">Seleziona...</option>
                            <option value="positive">Positivo</option>
                            <option value="neutral">Neutro</option>
                            <option value="negative">Negativo</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Note consulto</label>
                        <input type="text" id="visit-notes" placeholder="Appunti dalla visita...">
                    </div>
                    <button class="btn-secondary" onclick="saveDietologVisit()">Salva visita</button>
                </div>

                <div class="motivation-box">
                    <p id="motivation-text">"Ogni giorno e un passo verso il tuo obiettivo!"</p>
                </div>
            </div>

            <!-- Tab: Profile -->
            <div id="tab-profile" class="tab-content hidden">
                <div class="card">
                    <div class="card-title">Profilo</div>
                    <div style="text-align: center; margin-bottom: 12px;">
                        <div class="profile-photo" id="profile-photo">P</div>
                        <div style="font-size: 18px; font-weight: 600;" id="profile-name">Paolo</div>
                        <div class="level-badge" id="profile-level">Principiante</div>
                    </div>
                    <div class="stats-row">
                        <div class="stat">
                            <div class="stat-value" id="total-days">0</div>
                            <div class="stat-label">Giorni totali</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="best-streak">0</div>
                            <div class="stat-label">Miglior streak</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Badge</div>
                    <div class="badge-grid" id="badge-grid"></div>
                </div>

                <div class="card">
                    <div class="card-title">Impostazioni</div>
                    <button class="btn-secondary" onclick="editProfile()">Modifica profilo</button>
                    <button class="btn-secondary" onclick="switchUser()">Cambia utente</button>
                    <button class="btn-secondary" style="color: var(--error);" onclick="resetData()">Reset dati</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Food options
    const FOODS = {
        colazione: {
            bevanda: ['Te', 'Caffe', 'Camomilla'],
            accompagnamento: ['Yogurt greco 0,1%', 'PAT']
        },
        mezzaMattina: {
            proteina: ['Uovo sodo', 'Bresaola 30g', 'Fesa tacchino 30g', 'Yogurt greco']
        },
        pomeriggio: {
            bevanda: ['Te', 'Caffe', 'Camomilla'],
            accompagnamento: ['Yogurt greco 0,1%', 'PAT']
        },
        pranzo: {
            verdura: ['Insalata mista', 'Verdura cotta', 'Insalata + verdura'],
            proteina: [
                { id: 'carne', name: 'Carne bianca', qtyF: '100g', qtyP: '150g', items: ['Pollo', 'Tacchino', 'Vitello', 'Manzo', 'Coniglio', 'Puledro'] },
                { id: 'pesce', name: 'Pesce magro', qtyF: '200g', qtyP: '250g', items: ['Orata', 'Branzino', 'Merluzzo', 'Sogliola', 'Rombo', 'Tonno x2'] },
                { id: 'crostacei', name: 'Crostacei/Molluschi', qtyF: '200g', qtyP: '250g', items: ['Gamberi', 'Scampi', 'Cozze', 'Vongole', 'Seppie', 'Calamari'] },
                { id: 'affettato', name: 'Affettato magro', qtyF: '60g', qtyP: '80g', items: ['Bresaola', 'Prosciutto crudo', 'Carpaccio', 'Fesa tacchino'] },
                { id: 'formaggio', name: 'Formaggio magro', qtyF: '60g', qtyP: '80g', items: ['Asiago', 'Primo sale', 'Feta', 'Trenta'] },
                { id: 'uova', name: 'Uova sode', qtyF: '2', qtyP: '2', items: [] }
            ]
        },
        cena: {
            carbo: [
                { id: 'pasta', name: 'Pasta integrale', qtyF: '50-60g', qtyP: '80-100g' },
                { id: 'riso', name: 'Riso integrale', qtyF: '50-60g', qtyP: '80-100g' },
                { id: 'minestrone', name: 'Minestrone', qtyF: '100-150g', qtyP: '100-150g' }
            ],
            verdura: ['Insalata mista', 'Verdura cotta', 'Insalata + verdura'],
            proteina: [
                { id: 'carne', name: 'Carne bianca', qtyF: '100g', qtyP: '150g', items: ['Pollo', 'Tacchino', 'Vitello', 'Manzo', 'Coniglio', 'Puledro'] },
                { id: 'pesce', name: 'Pesce magro', qtyF: '200g', qtyP: '250g', items: ['Orata', 'Branzino', 'Merluzzo', 'Sogliola', 'Rombo', 'Tonno x1'] },
                { id: 'crostacei', name: 'Crostacei/Molluschi', qtyF: '200g', qtyP: '250g', items: ['Gamberi', 'Scampi', 'Cozze', 'Vongole', 'Seppie', 'Calamari'] },
                { id: 'affettato', name: 'Affettato magro', qtyF: '60g', qtyP: '80g', items: ['Bresaola', 'Prosciutto crudo', 'Carpaccio', 'Fesa tacchino'] },
                { id: 'formaggio', name: 'Formaggio magro', qtyF: '60g', qtyP: '80g', items: ['Asiago', 'Primo sale', 'Feta', 'Trenta'] },
                { id: 'uova', name: 'Uovo sodo', qtyF: '1', qtyP: '1', items: [] }
            ]
        }
    };

    const BADGES = [
        { id: 'first_day', name: 'Primo giorno', emoji: '1', check: d => d.totalDays >= 1 },
        { id: 'week_1', name: '1 settimana', emoji: '7', check: d => d.totalDays >= 7 },
        { id: 'week_4', name: '1 mese', emoji: '30', check: d => d.totalDays >= 30 },
        { id: 'streak_3', name: 'Streak 3', emoji: 'S3', check: d => d.bestStreak >= 3 },
        { id: 'streak_7', name: 'Streak 7', emoji: 'S7', check: d => d.bestStreak >= 7 },
        { id: 'streak_14', name: 'Streak 14', emoji: 'S14', check: d => d.bestStreak >= 14 },
        { id: 'kg_1', name: '-1 kg', emoji: '-1', check: d => d.lost >= 1 },
        { id: 'kg_3', name: '-3 kg', emoji: '-3', check: d => d.lost >= 3 },
        { id: 'kg_5', name: '-5 kg', emoji: '-5', check: d => d.lost >= 5 }
    ];

    const LEVELS = [
        { name: 'Principiante', pts: 0 },
        { name: 'Apprendista', pts: 50 },
        { name: 'Guerriero', pts: 150 },
        { name: 'Campione', pts: 300 },
        { name: 'Leggenda', pts: 500 }
    ];

    const MOTIVATIONS = [
        "Ogni giorno e un passo verso il tuo obiettivo!",
        "La costanza batte sempre il talento.",
        "Sei piu forte di quanto pensi!",
        "Il tuo corpo ti ringraziera.",
        "Non mollare, sei sulla strada giusta!",
        "Piccoli progressi portano a grandi risultati.",
        "Oggi e il giorno perfetto per continuare!",
        "La disciplina e il ponte tra obiettivi e risultati.",
        "Credi in te stesso, ce la stai facendo!",
        "Ogni scelta sana conta."
    ];

    // State
    let state = { currentUser: null, users: {} };

    function createNewUser() {
        return {
            startDate: null,
            startWeight: null,
            goalWeight: null,
            targetWeeks: null,
            currentWeight: null,
            points: 0,
            streak: 0,
            bestStreak: 0,
            totalDays: 0,
            photo: null,
            prefs: {},
            days: {},
            visits: []
        };
    }

    function loadState() {
        try {
            const saved = localStorage.getItem('nunziaDietApp');
            if (saved) state = JSON.parse(saved);
        } catch (e) {
            console.log('Reset state');
            state = { currentUser: null, users: {} };
        }
        updateUserAvatars();
    }

    function saveState() {
        localStorage.setItem('nunziaDietApp', JSON.stringify(state));
    }

    function getUser() {
        return state.users[state.currentUser];
    }

    function getToday() {
        return new Date().toISOString().split('T')[0];
    }

    function getTodayData() {
        const user = getUser();
        const today = getToday();
        if (!user.days[today]) {
            user.days[today] = { water: 0, activity: false, meals: {}, done: false };
        }
        return user.days[today];
    }

    function isPaolo() {
        return state.currentUser === 'Paolo';
    }

    // Photo handling
    function handlePhotoUpload(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('photo-preview-img');
                img.src = e.target.result;
                img.classList.remove('hidden');
                document.getElementById('photo-placeholder').classList.add('hidden');

                // Save to user if exists
                if (state.currentUser && state.users[state.currentUser]) {
                    state.users[state.currentUser].photo = e.target.result;
                    saveState();
                    updateUserAvatars();
                }
            };
            reader.readAsDataURL(file);
        }
    }

    function updateUserAvatars() {
        ['Paolo', 'Flora'].forEach(name => {
            const avatarEl = document.getElementById('avatar-' + name.toLowerCase());
            if (avatarEl && state.users[name] && state.users[name].photo) {
                avatarEl.innerHTML = `<img src="${state.users[name].photo}">`;
            } else if (avatarEl) {
                avatarEl.innerHTML = name[0];
            }
        });
    }

    // Screens
    function showScreen(name) {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById('screen-' + name).classList.remove('hidden');
    }

    function showTab(name) {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        event.target.classList.add('active');
        document.getElementById('tab-' + name).classList.remove('hidden');
        if (name === 'weekly') renderWeekly();
        if (name === 'profile') renderProfile();
    }

    // User selection
    function selectUser(name) {
        state.currentUser = name;
        if (!state.users[name]) {
            state.users[name] = createNewUser();
            saveState();
            showScreen('setup');
            setupPhotoPreview();
        } else {
            saveState();
            showScreen('dashboard');
            initDashboard();
        }
    }

    function setupPhotoPreview() {
        const user = getUser();
        const img = document.getElementById('photo-preview-img');
        const placeholder = document.getElementById('photo-placeholder');

        if (user && user.photo) {
            img.src = user.photo;
            img.classList.remove('hidden');
            placeholder.classList.add('hidden');
        } else {
            img.classList.add('hidden');
            placeholder.classList.remove('hidden');
        }
    }

    function saveSetup() {
        const user = getUser();
        user.startDate = document.getElementById('start-date').value;
        user.startWeight = parseFloat(document.getElementById('start-weight').value);
        user.goalWeight = parseFloat(document.getElementById('goal-weight').value);
        user.targetWeeks = parseInt(document.getElementById('target-weeks').value);
        user.currentWeight = user.startWeight;

        // Save photo if uploaded during setup
        const img = document.getElementById('photo-preview-img');
        if (img.src && !img.classList.contains('hidden')) {
            user.photo = img.src;
        }

        saveState();
        updateUserAvatars();
        showScreen('dashboard');
        initDashboard();
    }

    // Dashboard
    function initDashboard() {
        getTodayData();
        updateStats();
        renderWater();
        renderActivity();
        renderMeals();
    }

    function updateStats() {
        const user = getUser();
        const dayNum = user.startDate ? Math.floor((new Date() - new Date(user.startDate)) / 86400000) + 1 : 1;
        document.getElementById('day-counter').textContent = dayNum;
        document.getElementById('streak-counter').textContent = user.streak;
        document.getElementById('points-counter').textContent = user.points;
    }

    // Water
    function renderWater() {
        const data = getTodayData();
        const el = document.getElementById('water-tracker');
        el.innerHTML = '';
        for (let i = 0; i < 4; i++) {
            const drop = document.createElement('div');
            drop.className = 'water-drop' + (i < data.water ? ' filled' : '');
            drop.textContent = '0.5';
            drop.onclick = () => { data.water = i + 1; saveState(); renderWater(); };
            el.appendChild(drop);
        }
        const total = document.createElement('span');
        total.className = 'water-total';
        total.textContent = (data.water * 0.5) + ' L';
        el.appendChild(total);
    }

    // Activity
    function renderActivity() {
        const data = getTodayData();
        document.getElementById('activity-toggle').classList.toggle('active', data.activity);
        document.getElementById('activity-switch').classList.toggle('active', data.activity);
    }

    function toggleActivity() {
        const data = getTodayData();
        data.activity = !data.activity;
        saveState();
        renderActivity();
    }

    // Meals
    function renderMeals() {
        const container = document.getElementById('meals-container');
        container.innerHTML = '';
        container.appendChild(createMealColazione());
        container.appendChild(createMealMezzaMattina());
        container.appendChild(createMealPranzo());
        container.appendChild(createMealPomeriggio());
        container.appendChild(createMealCena());
    }

    function getMealData(mealKey) {
        const data = getTodayData();
        if (!data.meals[mealKey]) data.meals[mealKey] = { sel: {}, status: null };
        return data.meals[mealKey];
    }

    function setMealSel(mealKey, key, value) {
        const meal = getMealData(mealKey);
        meal.sel[key] = value;
        const user = getUser();
        if (!user.prefs[mealKey]) user.prefs[mealKey] = {};
        user.prefs[mealKey][key] = value;
        saveState();
        renderMeals();
    }

    function setMealStatus(mealKey, status) {
        getMealData(mealKey).status = status;
        saveState();
        renderMeals();
    }

    function getPref(mealKey, key) {
        const user = getUser();
        return user.prefs[mealKey] ? user.prefs[mealKey][key] : null;
    }

    function btnGroup(mealKey, key, options, selected) {
        return `<div class="choice-buttons">${options.map(o =>
            `<button class="choice-btn${selected === o ? ' selected' : ''}" onclick="setMealSel('${mealKey}','${key}','${o}')">${o}</button>`
        ).join('')}</div>`;
    }

    function statusBtns(mealKey, status) {
        return `<div class="meal-actions">
            <button class="meal-btn ok${status === 'ok' ? ' active' : ''}" onclick="setMealStatus('${mealKey}','ok')">OK</button>
            <button class="meal-btn sgarro${status === 'sgarro' ? ' active' : ''}" onclick="setMealStatus('${mealKey}','sgarro')">Sgarro</button>
        </div>`;
    }

    function createMealColazione() {
        const m = getMealData('colazione');
        const card = document.createElement('div');
        card.className = 'meal-card';
        card.innerHTML = `
            <div class="meal-header"><span class="meal-time">Colazione</span></div>
            <div class="choice-group">
                <div class="choice-label">Bevanda</div>
                ${btnGroup('colazione', 'bevanda', FOODS.colazione.bevanda, m.sel.bevanda || getPref('colazione', 'bevanda'))}
            </div>
            <div class="choice-group">
                <div class="choice-label">Accompagnamento</div>
                ${btnGroup('colazione', 'accompagnamento', FOODS.colazione.accompagnamento, m.sel.accompagnamento || getPref('colazione', 'accompagnamento'))}
            </div>
            ${statusBtns('colazione', m.status)}
        `;
        return card;
    }

    function createMealMezzaMattina() {
        const m = getMealData('mezzaMattina');
        const card = document.createElement('div');
        card.className = 'meal-card';
        card.innerHTML = `
            <div class="meal-header"><span class="meal-time">Mezza Mattinata</span></div>
            <div class="choice-group">
                <div class="choice-label">Proteina</div>
                ${btnGroup('mezzaMattina', 'proteina', FOODS.mezzaMattina.proteina, m.sel.proteina || getPref('mezzaMattina', 'proteina'))}
            </div>
            ${statusBtns('mezzaMattina', m.status)}
        `;
        return card;
    }

    function createMealPomeriggio() {
        const m = getMealData('pomeriggio');
        const card = document.createElement('div');
        card.className = 'meal-card';
        card.innerHTML = `
            <div class="meal-header"><span class="meal-time">Pomeriggio</span></div>
            <div class="choice-group">
                <div class="choice-label">Bevanda</div>
                ${btnGroup('pomeriggio', 'bevanda', FOODS.pomeriggio.bevanda, m.sel.bevanda || getPref('pomeriggio', 'bevanda'))}
            </div>
            <div class="choice-group">
                <div class="choice-label">Accompagnamento</div>
                ${btnGroup('pomeriggio', 'accompagnamento', FOODS.pomeriggio.accompagnamento, m.sel.accompagnamento || getPref('pomeriggio', 'accompagnamento'))}
            </div>
            ${statusBtns('pomeriggio', m.status)}
        `;
        return card;
    }

    function createMealPranzo() {
        const m = getMealData('pranzo');
        const p = isPaolo();
        const card = document.createElement('div');
        card.className = 'meal-card';

        let protDetail = '';
        if (m.sel.proteina) {
            const prot = FOODS.pranzo.proteina.find(x => x.id === m.sel.proteina);
            if (prot && prot.items.length > 0) {
                protDetail = `<div class="detail-section">
                    <div class="choice-label">${prot.name} - scegli tipo</div>
                    <div class="choice-buttons">${prot.items.map(i =>
                        `<button class="choice-btn small${m.sel.protItem === i ? ' selected' : ''}" onclick="setMealSel('pranzo','protItem','${i}')">${i}</button>`
                    ).join('')}</div>
                    <div class="qty-note">Quantita: ${p ? prot.qtyP : prot.qtyF}</div>
                </div>`;
            }
        }

        card.innerHTML = `
            <div class="meal-header"><span class="meal-time">Pranzo</span></div>
            <div class="choice-group">
                <div class="choice-label">Verdura</div>
                ${btnGroup('pranzo', 'verdura', FOODS.pranzo.verdura, m.sel.verdura || getPref('pranzo', 'verdura'))}
            </div>
            <div class="choice-group">
                <div class="choice-label">Proteina</div>
                <div class="choice-buttons">${FOODS.pranzo.proteina.map(pr =>
                    `<button class="choice-btn${m.sel.proteina === pr.id ? ' selected' : ''}" onclick="setMealSel('pranzo','proteina','${pr.id}');setMealSel('pranzo','protItem',null)">${pr.name}<br><small>${p ? pr.qtyP : pr.qtyF}</small></button>`
                ).join('')}</div>
            </div>
            ${protDetail}
            ${statusBtns('pranzo', m.status)}
        `;
        return card;
    }

    function createMealCena() {
        const m = getMealData('cena');
        const p = isPaolo();
        const card = document.createElement('div');
        card.className = 'meal-card';

        let protDetail = '';
        if (m.sel.proteina) {
            const prot = FOODS.cena.proteina.find(x => x.id === m.sel.proteina);
            if (prot && prot.items.length > 0) {
                protDetail = `<div class="detail-section">
                    <div class="choice-label">${prot.name} - scegli tipo</div>
                    <div class="choice-buttons">${prot.items.map(i =>
                        `<button class="choice-btn small${m.sel.protItem === i ? ' selected' : ''}" onclick="setMealSel('cena','protItem','${i}')">${i}</button>`
                    ).join('')}</div>
                    <div class="qty-note">Quantita: ${p ? prot.qtyP : prot.qtyF}</div>
                </div>`;
            }
        }

        card.innerHTML = `
            <div class="meal-header"><span class="meal-time">Cena</span></div>
            <div class="choice-group">
                <div class="choice-label">Carboidrato</div>
                <div class="choice-buttons">${FOODS.cena.carbo.map(c =>
                    `<button class="choice-btn${m.sel.carbo === c.id ? ' selected' : ''}" onclick="setMealSel('cena','carbo','${c.id}')">${c.name}<br><small>${p ? c.qtyP : c.qtyF}</small></button>`
                ).join('')}</div>
            </div>
            <div class="choice-group">
                <div class="choice-label">Verdura</div>
                ${btnGroup('cena', 'verdura', FOODS.cena.verdura, m.sel.verdura || getPref('cena', 'verdura'))}
            </div>
            <div class="choice-group">
                <div class="choice-label">Proteina</div>
                <div class="choice-buttons">${FOODS.cena.proteina.map(pr =>
                    `<button class="choice-btn${m.sel.proteina === pr.id ? ' selected' : ''}" onclick="setMealSel('cena','proteina','${pr.id}');setMealSel('cena','protItem',null)">${pr.name}<br><small>${p ? pr.qtyP : pr.qtyF}</small></button>`
                ).join('')}</div>
            </div>
            ${protDetail}
            ${statusBtns('cena', m.status)}
        `;
        return card;
    }

    // Save day
    function saveDay() {
        const data = getTodayData();
        const meals = ['colazione', 'mezzaMattina', 'pranzo', 'pomeriggio', 'cena'];
        const allSet = meals.every(k => data.meals[k] && data.meals[k].status);

        if (!allSet) {
            alert('Completa tutti i pasti prima di salvare!');
            return;
        }

        const user = getUser();
        const hasSgarro = meals.some(k => data.meals[k].status === 'sgarro');
        data.done = true;

        if (hasSgarro) {
            user.streak = 0;
        } else {
            user.streak++;
            user.points += 10;
            if (data.water >= 4) user.points += 5;
            if (data.activity) user.points += 5;
        }

        user.totalDays++;
        if (user.streak > user.bestStreak) user.bestStreak = user.streak;

        saveState();
        updateStats();

        const bonus = (!hasSgarro ? (10 + (data.water >= 4 ? 5 : 0) + (data.activity ? 5 : 0)) : 0);
        alert(hasSgarro ? 'Giornata salvata. Domani si riparte!' : 'Ottimo lavoro! +' + bonus + ' punti!');
    }

    // Weekly
    function renderWeekly() {
        const user = getUser();
        const grid = document.getElementById('week-grid');
        grid.innerHTML = '';
        const today = new Date();
        const dayNames = ['D', 'L', 'M', 'M', 'G', 'V', 'S'];
        let okCount = 0, sgarroCount = 0;

        for (let i = 6; i >= 0; i--) {
            const d = new Date(today);
            d.setDate(d.getDate() - i);
            const dateStr = d.toISOString().split('T')[0];
            const dayData = user.days[dateStr];

            let status = '-';
            if (dayData && dayData.done) {
                const hasSgarro = Object.values(dayData.meals).some(m => m.status === 'sgarro');
                status = hasSgarro ? 'x' : 'v';
                hasSgarro ? sgarroCount++ : okCount++;
            }

            const el = document.createElement('div');
            el.className = 'week-day' + (i === 0 ? ' today' : '');
            el.innerHTML = `<div class="week-day-name">${dayNames[d.getDay()]}</div><div class="week-day-status">${status}</div>`;
            grid.appendChild(el);
        }

        document.getElementById('week-ok').textContent = okCount;
        document.getElementById('week-sgarro').textContent = sgarroCount;
        const total = okCount + sgarroCount;
        document.getElementById('week-adherence').textContent = total > 0 ? Math.round(okCount / total * 100) + '%' : '-';

        document.getElementById('start-w-label').textContent = 'Inizio: ' + (user.startWeight || '--') + ' kg';
        document.getElementById('goal-w-label').textContent = 'Obiettivo: ' + (user.goalWeight || '--') + ' kg';
        document.getElementById('current-weight').value = user.currentWeight || '';
        updateWeightProgress();

        document.getElementById('motivation-text').textContent = '"' + MOTIVATIONS[Math.floor(Math.random() * MOTIVATIONS.length)] + '"';
    }

    function updateWeight() {
        const user = getUser();
        user.currentWeight = parseFloat(document.getElementById('current-weight').value);
        saveState();
        updateWeightProgress();
    }

    function updateWeightProgress() {
        const user = getUser();
        if (!user.startWeight || !user.goalWeight || !user.currentWeight) return;
        const tolose = user.startWeight - user.goalWeight;
        const lost = user.startWeight - user.currentWeight;
        const pct = Math.min(100, Math.max(0, (lost / tolose) * 100));
        document.getElementById('weight-progress').style.width = pct + '%';
        document.getElementById('weight-diff').textContent = lost.toFixed(1) + ' kg persi su ' + tolose.toFixed(1) + ' kg obiettivo';
    }

    function saveDietologVisit() {
        const user = getUser();
        user.visits.push({
            date: document.getElementById('visit-date').value,
            outcome: document.getElementById('visit-outcome').value,
            notes: document.getElementById('visit-notes').value
        });
        saveState();
        alert('Visita salvata!');
    }

    // Profile
    function renderProfile() {
        const user = getUser();

        const photoEl = document.getElementById('profile-photo');
        if (user.photo) {
            photoEl.innerHTML = `<img src="${user.photo}">`;
        } else {
            photoEl.innerHTML = state.currentUser[0];
        }

        document.getElementById('profile-name').textContent = state.currentUser;
        document.getElementById('total-days').textContent = user.totalDays;
        document.getElementById('best-streak').textContent = user.bestStreak;

        const level = LEVELS.slice().reverse().find(l => user.points >= l.pts);
        document.getElementById('profile-level').textContent = level.name;

        const lost = (user.startWeight && user.currentWeight) ? user.startWeight - user.currentWeight : 0;
        const badgeData = { totalDays: user.totalDays, bestStreak: user.bestStreak, lost };

        const grid = document.getElementById('badge-grid');
        grid.innerHTML = '';
        BADGES.forEach(b => {
            const earned = b.check(badgeData);
            const el = document.createElement('div');
            el.className = 'badge' + (earned ? ' earned' : '');
            el.innerHTML = `<span>${b.emoji}</span><span>${b.name}</span>`;
            grid.appendChild(el);
        });
    }

    function editProfile() {
        const user = getUser();
        document.getElementById('start-date').value = user.startDate || '';
        document.getElementById('start-weight').value = user.startWeight || '';
        document.getElementById('goal-weight').value = user.goalWeight || '';
        document.getElementById('target-weeks').value = user.targetWeeks || '';
        showScreen('setup');
        setupPhotoPreview();
    }

    function switchUser() {
        state.currentUser = null;
        saveState();
        showScreen('select');
    }

    function resetData() {
        if (confirm('Sei sicuro di voler cancellare tutti i dati?')) {
            localStorage.removeItem('nunziaDietApp');
            state = { currentUser: null, users: {} };
            showScreen('select');
        }
    }

    // Init
    loadState();
    if (state.currentUser && state.users[state.currentUser] && state.users[state.currentUser].startDate) {
        showScreen('dashboard');
        initDashboard();
    } else if (state.currentUser) {
        showScreen('setup');
        setupPhotoPreview();
    } else {
        showScreen('select');
    }

    // Register service worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }
    </script>
</body>
</html>

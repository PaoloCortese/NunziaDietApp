<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#F8FAFC" id="theme-color-meta">
    <meta name="apple-mobile-web-app-title" content="NunziaDiet">
    <title>NunziaDiet</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        :root {
            --bg: #F8FAFC;
            --card: #FFFFFF;
            --border: #E2E8F0;
            --accent: #5AC8FA;
            --accent-light: #E0F4FD;
            --text: #1E293B;
            --text-secondary: #94A3B8;
            --success: #34D399;
            --error: #F87171;
            --warning: #FBBF24;
        }

        [data-theme="dark"] {
            --bg: #0F172A;
            --card: #1E293B;
            --border: #334155;
            --accent: #5AC8FA;
            --accent-light: #1E3A5F;
            --text: #F1F5F9;
            --text-secondary: #94A3B8;
            --success: #34D399;
            --error: #F87171;
            --warning: #FBBF24;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 100px;
            -webkit-font-smoothing: antialiased;
            transition: background 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        .container { max-width: 420px; margin: 0 auto; padding: 16px; }

        .header {
            text-align: center;
            padding: 16px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 20px;
            font-weight: 600;
            color: var(--accent);
            letter-spacing: -0.5px;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header-user {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .header-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            color: var(--accent);
            overflow: hidden;
        }
        .header-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .header-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
        }
        .theme-toggle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--card);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }
        .theme-toggle:active { transform: scale(0.95); }

        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            transition: background 0.3s, border-color 0.3s;
        }

        .card-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .stats-row { display: flex; justify-content: space-around; text-align: center; }
        .stat { flex: 1; }
        .stat-value { font-size: 28px; font-weight: 600; color: var(--text); }
        .stat-label { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
        .stat-value.streak { color: var(--warning); }
        .stat-value.points { color: var(--accent); }

        .user-select { display: flex; gap: 12px; margin-bottom: 16px; }
        .user-btn {
            flex: 1;
            padding: 20px 16px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--card);
            font-size: 15px;
            font-weight: 500;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .user-btn:active { transform: scale(0.98); }
        .user-btn.active { border-color: var(--accent); background: var(--accent-light); }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--accent-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            color: var(--accent);
            overflow: hidden;
        }
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .input-group { margin-bottom: 14px; }
        .input-group label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
            background: var(--card);
            color: var(--text);
        }
        .input-group input:focus, .input-group textarea:focus { border-color: var(--accent); }
        .input-group textarea { resize: none; min-height: 60px; font-family: inherit; }

        .water-tracker {
            display: flex;
            justify-content: center;
            gap: 8px;
            align-items: center;
        }
        .water-drop {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        .water-drop.filled {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
            animation: dropFill 0.3s ease;
        }
        @keyframes dropFill {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .water-total {
            font-size: 14px;
            color: var(--text);
            font-weight: 500;
            margin-left: 8px;
            min-width: 40px;
        }

        .activity-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px;
            background: var(--bg);
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        .activity-toggle.active { background: var(--accent-light); }

        .toggle-switch {
            width: 48px;
            height: 28px;
            background: var(--border);
            border-radius: 14px;
            position: relative;
            transition: background 0.2s;
            flex-shrink: 0;
        }
        .toggle-switch.active { background: var(--accent); }
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .toggle-switch.active::after { transform: translateX(20px); }

        /* Day Navigator */
        .day-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--card);
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
        }
        .day-nav-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--bg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: var(--text);
            transition: all 0.2s;
        }
        .day-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .day-nav-btn:active:not(:disabled) { transform: scale(0.95); background: var(--accent-light); }
        .day-nav-date {
            font-size: 15px;
            font-weight: 600;
            color: var(--text);
        }
        .day-nav-today {
            font-size: 11px;
            color: var(--accent);
            text-transform: uppercase;
        }

        .meal-card {
            background: var(--card);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }
        .meal-card.saved { opacity: 0.7; }
        .meal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .meal-time {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        .choice-group { margin-bottom: 12px; }
        .choice-label {
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 6px;
            font-weight: 500;
            letter-spacing: 0.3px;
        }
        .choice-buttons { display: flex; flex-wrap: wrap; gap: 6px; }
        .choice-btn {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--card);
            font-size: 12px;
            font-weight: 500;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }
        .choice-btn:active { transform: scale(0.96); }
        .choice-btn.selected {
            border-color: var(--accent);
            background: var(--accent-light);
            color: var(--accent);
            animation: btnSelect 0.2s ease;
        }
        @keyframes btnSelect {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .choice-btn.small { padding: 6px 10px; font-size: 11px; }

        .meal-actions { display: flex; gap: 8px; margin-top: 12px; }
        .meal-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--card);
        }
        .meal-btn.ok { color: var(--success); border-color: var(--success); }
        .meal-btn.ok.active { background: var(--success); color: #fff; }
        .meal-btn.sgarro { color: var(--error); border-color: var(--error); }
        .meal-btn.sgarro.active { background: var(--error); color: #fff; }
        .meal-btn.skip { color: var(--text-secondary); border-color: var(--border); }
        .meal-btn.skip.active { background: var(--text-secondary); color: #fff; }

        .meal-note {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }
        .meal-note input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 12px;
            background: var(--bg);
            color: var(--text);
            outline: none;
        }
        .meal-note input:focus { border-color: var(--accent); }

        .btn-primary {
            width: 100%;
            padding: 14px;
            background: var(--accent);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
        }
        .btn-primary:active { transform: scale(0.98); opacity: 0.9; }

        .btn-secondary {
            width: 100%;
            padding: 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-row {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }
        .btn-row .btn-primary,
        .btn-row .btn-secondary {
            flex: 1;
            margin-top: 0;
        }

        .nav-tabs {
            display: flex;
            background: var(--card);
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
        }
        .nav-tab {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
        }
        .nav-tab.active { background: var(--accent); color: #fff; }

        .week-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            margin-bottom: 16px;
        }
        .week-day {
            text-align: center;
            padding: 10px 4px;
            background: var(--bg);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .week-day:active { transform: scale(0.95); }
        .week-day-name { font-size: 10px; color: var(--text-secondary); margin-bottom: 4px; }
        .week-day-num { font-size: 12px; color: var(--text); font-weight: 500; margin-bottom: 2px; }
        .week-day-status { font-size: 14px; }
        .week-day.today {
            background: var(--accent-light);
            border: 1px solid var(--accent);
        }
        .week-day.selected {
            background: var(--accent);
        }
        .week-day.selected .week-day-name,
        .week-day.selected .week-day-num { color: #fff; }

        /* Weight Chart */
        .weight-chart {
            height: 120px;
            margin: 16px 0;
            position: relative;
        }
        .weight-chart canvas {
            width: 100%;
            height: 100%;
        }

        .progress-bar {
            height: 6px;
            background: var(--bg);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .level-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: var(--accent-light);
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            color: var(--accent);
            margin-top: 6px;
        }

        .motivation-box {
            background: var(--bg);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
            border: 1px solid var(--border);
            margin-top: 12px;
        }
        .motivation-box p {
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-secondary);
            font-style: italic;
        }

        .dietolog-card {
            background: var(--accent-light);
            border-color: var(--accent);
        }

        .hidden { display: none !important; }

        .badge-grid { display: flex; flex-wrap: wrap; gap: 6px; }
        .badge {
            padding: 6px 10px;
            background: var(--bg);
            border-radius: 16px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
            opacity: 0.4;
            border: 1px solid var(--border);
            color: var(--text);
        }
        .badge.earned {
            background: var(--accent-light);
            border-color: var(--accent);
            opacity: 1;
        }

        .detail-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }
        .qty-note {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .photo-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            padding: 16px;
        }
        .photo-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--bg);
            border: 2px dashed var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .photo-preview:hover { border-color: var(--accent); }
        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .photo-preview-placeholder {
            font-size: 24px;
            color: var(--text-secondary);
        }
        .photo-upload input[type="file"] { display: none; }
        .photo-upload-text {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .profile-photo {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: var(--accent-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 600;
            color: var(--accent);
            overflow: hidden;
            margin: 0 auto 8px;
        }
        .profile-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* History Modal */
        .history-day {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
        }
        .history-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }
        .history-day-date {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }
        .history-day-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
        }
        .history-day-status.ok { background: var(--success); color: #fff; }
        .history-day-status.sgarro { background: var(--error); color: #fff; }
        .history-meal {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            font-size: 13px;
        }
        .history-meal-name { color: var(--text-secondary); }
        .history-meal-value { color: var(--text); font-weight: 500; }
        .history-meal-status {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #fff;
        }
        .history-meal-status.ok { background: var(--success); }
        .history-meal-status.sgarro { background: var(--error); }
        .history-meal-status.skip { background: var(--text-secondary); }

        /* History Week */
        .history-week {
            background: var(--card);
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
            overflow: hidden;
        }
        .history-week-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            cursor: pointer;
        }
        .history-week-header:active {
            background: var(--bg);
        }
        .history-week-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .history-week-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--accent);
        }
        .history-week-period {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .history-week-stats {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            font-weight: 500;
        }
        .history-week-arrow {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text-secondary);
        }
        .history-week-content {
            border-top: 1px solid var(--border);
            padding: 8px;
        }
        .history-day-mini {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 4px;
        }
        .history-day-mini:active {
            background: var(--bg);
        }
        .history-day-mini-date {
            width: 60px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
        }
        .history-day-mini-info {
            flex: 1;
            font-size: 12px;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .history-visit {
            background: var(--card);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 8px;
            border: 2px solid var(--accent);
        }
        .history-visit-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .history-visit-date {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Success Animation */
        .success-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .success-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        .success-content {
            background: var(--card);
            border-radius: 20px;
            padding: 32px;
            text-align: center;
            transform: scale(0.8);
            transition: transform 0.3s;
        }
        .success-overlay.show .success-content {
            transform: scale(1);
        }
        .success-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: var(--success);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-size: 32px;
            color: #fff;
            animation: successPop 0.5s ease;
        }
        @keyframes successPop {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .success-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
        }
        .success-points {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
        }

        /* Confetti */
        .confetti {
            position: fixed;
            top: -10px;
            z-index: 1001;
            animation: confettiFall 3s linear forwards;
        }
        @keyframes confettiFall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* Swipe Container */
        .swipe-container {
            overflow: hidden;
            touch-action: pan-y;
        }
        .swipe-content {
            transition: transform 0.3s ease;
        }

        /* Detail Modal */
        .detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .detail-modal.show {
            opacity: 1;
            pointer-events: auto;
        }
        .detail-modal-content {
            background: var(--card);
            border-radius: 20px 20px 0 0;
            padding: 20px;
            width: 100%;
            max-width: 420px;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s;
        }
        .detail-modal.show .detail-modal-content {
            transform: translateY(0);
        }
        .detail-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }
        .detail-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
        }
        .detail-modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: var(--bg);
            font-size: 18px;
            cursor: pointer;
            color: var(--text);
        }
        .detail-section-card {
            background: var(--bg);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
        }
        .detail-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 14px;
        }
        .detail-row-label { color: var(--text-secondary); }
        .detail-row-value { color: var(--text); font-weight: 500; }
        .detail-meal-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
        }
        .detail-meal-status.ok { background: var(--success); color: #fff; }
        .detail-meal-status.sgarro { background: var(--error); color: #fff; }
        .detail-meal-status.skip { background: var(--text-secondary); color: #fff; }

        /* Quick weight input */
        .weight-quick {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--bg);
            border-radius: 10px;
        }
        .weight-quick input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            background: var(--card);
            color: var(--text);
            text-align: center;
        }
        .weight-quick-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            background: var(--accent);
            color: #fff;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }
        .weight-display {
            text-align: center;
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>NunziaDiet</h1>
            <div style="display:flex;align-items:center;gap:8px;">
                <div class="header-user" id="header-user" onclick="switchUser()">
                    <span class="header-name" id="header-name"></span>
                    <div class="header-avatar" id="header-avatar"></div>
                </div>
                <button class="theme-toggle" onclick="toggleTheme()" id="theme-btn">L</button>
            </div>
        </div>

        <!-- Screen: User Selection -->
        <div id="screen-select" class="screen">
            <div class="card">
                <div class="card-title">Chi sei?</div>
                <div class="user-select" id="user-select-container">
                    <!-- Users rendered dynamically -->
                </div>
            </div>
        </div>

        <!-- Screen: Setup -->
        <div id="screen-setup" class="screen hidden">
            <div class="card">
                <div class="card-title">Il tuo profilo</div>

                <div class="photo-upload">
                    <div class="photo-preview" onclick="document.getElementById('photo-input').click()">
                        <span class="photo-preview-placeholder" id="photo-placeholder">+</span>
                        <img id="photo-preview-img" class="hidden">
                    </div>
                    <input type="file" id="photo-input" accept="image/*" onchange="handlePhotoUpload(event)">
                    <span class="photo-upload-text">Tocca per aggiungere foto</span>
                </div>

                <div class="input-group">
                    <label>Data inizio dieta</label>
                    <input type="date" id="start-date">
                </div>
                <div class="input-group">
                    <label>Peso iniziale (kg)</label>
                    <input type="number" id="start-weight" step="0.1" placeholder="75.0">
                </div>
                <div class="input-group">
                    <label>Peso obiettivo (kg)</label>
                    <input type="number" id="goal-weight" step="0.1" placeholder="70.0">
                </div>
                <div class="input-group">
                    <label>Settimane target</label>
                    <input type="number" id="target-weeks" placeholder="8">
                </div>
                <button class="btn-primary" onclick="saveSetup()">Inizia</button>
            </div>
        </div>

        <!-- Screen: Dashboard -->
        <div id="screen-dashboard" class="screen hidden">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('daily')">Oggi</button>
                <button class="nav-tab" onclick="showTab('weekly')">Settimana</button>
                <button class="nav-tab" onclick="showTab('history')">Storico</button>
                <button class="nav-tab" onclick="showTab('profile')">Profilo</button>
            </div>

            <!-- Tab: Daily -->
            <div id="tab-daily" class="tab-content">
                <!-- Day Navigator -->
                <div class="day-nav">
                    <button class="day-nav-btn" onclick="changeDay(-1)" id="prev-day-btn">&lt;</button>
                    <div style="text-align: center;">
                        <div class="day-nav-date" id="current-day-label">Oggi</div>
                        <div class="day-nav-today hidden" id="today-indicator">OGGI</div>
                    </div>
                    <button class="day-nav-btn" onclick="changeDay(1)" id="next-day-btn">&gt;</button>
                </div>

                <div class="card">
                    <div class="stats-row">
                        <div class="stat">
                            <div class="stat-value" id="day-counter">1</div>
                            <div class="stat-label">Giorno</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value streak" id="streak-counter">0</div>
                            <div class="stat-label">Streak</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value points" id="points-counter">0</div>
                            <div class="stat-label">Punti</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Acqua - obiettivo 2L</div>
                    <div class="water-tracker" id="water-tracker"></div>
                </div>

                <div class="card">
                    <div class="card-title">Attivita fisica</div>
                    <div class="activity-toggle" id="activity-toggle" onclick="toggleActivity()">
                        <span>Hai fatto attivita oggi?</span>
                        <div class="toggle-switch" id="activity-switch"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Peso di oggi</div>
                    <div class="weight-quick">
                        <input type="number" id="daily-weight" step="0.1" placeholder="kg">
                        <button class="weight-quick-btn" onclick="saveDailyWeight()">Salva</button>
                    </div>
                    <div class="weight-display" id="weight-display">Ultimo peso: --</div>
                </div>

                <div class="card-title" style="margin: 16px 0 10px;">Pasti</div>
                <div id="meals-container"></div>

                <div class="btn-row">
                    <button class="btn-secondary" onclick="copyPreviousDay()">Copia ieri</button>
                    <button class="btn-primary" onclick="saveDay()">Salva</button>
                </div>
            </div>

            <!-- Tab: Weekly -->
            <div id="tab-weekly" class="tab-content hidden">
                <div class="card">
                    <div class="card-title">Questa settimana</div>
                    <div class="week-grid" id="week-grid"></div>
                    <div class="stats-row" style="margin-top: 12px;">
                        <div class="stat">
                            <div class="stat-value" style="color: var(--success);" id="week-ok">0</div>
                            <div class="stat-label">Giorni OK</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" style="color: var(--error);" id="week-sgarro">0</div>
                            <div class="stat-label">Sgarri</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="week-adherence">0%</div>
                            <div class="stat-label">Aderenza</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Andamento Peso</div>
                    <div class="weight-chart">
                        <canvas id="weight-canvas"></canvas>
                    </div>
                    <div class="input-group">
                        <label>Peso attuale (kg)</label>
                        <input type="number" id="current-weight" step="0.1" onchange="updateWeight()">
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary);">
                        <span id="start-w-label">Inizio: --</span>
                        <span id="goal-w-label">Obiettivo: --</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="weight-progress" style="width: 0%"></div>
                    </div>
                    <p style="text-align: center; font-size: 13px; color: var(--text);" id="weight-diff">-- kg persi</p>
                </div>

                <div class="card dietolog-card">
                    <div class="card-title">Check Dietologo</div>
                    <div class="input-group">
                        <label>Data visita</label>
                        <input type="date" id="visit-date">
                    </div>
                    <div class="input-group">
                        <label>Peso rilevato (kg)</label>
                        <input type="number" id="visit-weight" step="0.1" placeholder="Es: 82.5">
                    </div>
                    <div class="input-group">
                        <label>Esito</label>
                        <select id="visit-outcome">
                            <option value="">Seleziona...</option>
                            <option value="positive">Positivo</option>
                            <option value="neutral">Neutro</option>
                            <option value="negative">Negativo</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Note consulto</label>
                        <input type="text" id="visit-notes" placeholder="Appunti dalla visita...">
                    </div>
                    <button class="btn-secondary" onclick="saveDietologVisit()">Salva visita</button>
                </div>

                <div class="motivation-box">
                    <p id="motivation-text">"Ogni giorno e un passo verso il tuo obiettivo!"</p>
                </div>
            </div>

            <!-- Tab: History -->
            <div id="tab-history" class="tab-content hidden">
                <div class="card">
                    <div class="card-title">Storico Pasti</div>
                    <div id="history-container"></div>
                </div>
                <button class="btn-secondary" onclick="exportData()">Esporta CSV</button>
            </div>

            <!-- Tab: Profile -->
            <div id="tab-profile" class="tab-content hidden">
                <div class="card">
                    <div class="card-title">Profilo</div>
                    <div style="text-align: center; margin-bottom: 12px;">
                        <div class="profile-photo" id="profile-photo">P</div>
                        <div style="font-size: 18px; font-weight: 600;" id="profile-name">Paolo</div>
                        <div class="level-badge" id="profile-level">Principiante</div>
                    </div>
                    <div class="stats-row">
                        <div class="stat">
                            <div class="stat-value" id="total-days">0</div>
                            <div class="stat-label">Giorni totali</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="best-streak">0</div>
                            <div class="stat-label">Miglior streak</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Badge</div>
                    <div class="badge-grid" id="badge-grid"></div>
                </div>

                <div class="card">
                    <div class="card-title">Impostazioni</div>
                    <button class="btn-secondary" onclick="editProfile()">Modifica profilo</button>
                    <button class="btn-secondary" onclick="editUserName()">Cambia nome</button>
                    <button class="btn-secondary" onclick="switchUser()">Cambia utente</button>
                    <button class="btn-secondary" style="color: var(--accent);" onclick="generateTestData()">Genera dati test</button>
                    <button class="btn-secondary" style="color: var(--warning);" onclick="resetCurrentUser()">Reset miei dati</button>
                </div>

                <div class="card" id="admin-section">
                    <div class="card-title">Amministrazione</div>
                    <button class="btn-secondary" onclick="addNewUser()">Aggiungi utente</button>
                    <button class="btn-secondary" style="color: var(--error);" onclick="resetData()">Reset completo app</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Overlay -->
    <div class="success-overlay" id="success-overlay" onclick="hideSuccess()">
        <div class="success-content" onclick="event.stopPropagation()">
            <div class="success-icon">âœ“</div>
            <div class="success-title" id="success-title">Ottimo lavoro!</div>
            <div class="success-points" id="success-points">+20 punti</div>
        </div>
    </div>

    <!-- Day Detail Modal -->
    <div class="detail-modal" id="detail-modal" onclick="closeDetailModal()">
        <div class="detail-modal-content" onclick="event.stopPropagation()">
            <div class="detail-modal-header">
                <span class="detail-modal-title" id="detail-modal-title">Dettaglio giornata</span>
                <button class="detail-modal-close" onclick="closeDetailModal()">x</button>
            </div>
            <div id="detail-modal-body"></div>
        </div>
    </div>

    <script>
    // Food options
    // Verdure disponibili
    const INSALATE = ['Lattuga', 'Scarola', 'Pomodori', 'Zucchine', 'Ravanelli', 'Carciofi', 'Cetrioli', 'Finocchi', 'Funghi', 'Sedano', 'Spinaci', 'Friarielli', 'Verza', 'Rucola'];
    const VERDURE_COTTE = ['Asparagi', 'Melanzane', 'Bietole', 'Broccoli', 'Cavolfiore', 'Porri', 'Peperoni (no gialli)'];

    const FOODS = {
        colazione: {
            bevanda: ['Te', 'Caffe', 'Camomilla'],
            accompagnamento: ['Yogurt greco 0,1%', 'PAT']
        },
        mezzaMattina: {
            proteina: ['Uovo sodo', 'Bresaola 30g', 'Fesa tacchino 30g', 'Yogurt greco']
        },
        pomeriggio: {
            bevanda: ['Te', 'Caffe', 'Camomilla'],
            accompagnamento: ['Yogurt greco 0,1%', 'PAT']
        },
        pranzo: {
            verduraTipo: ['Insalata', 'Verdura cotta', 'Insalata + cotta'],
            proteina: [
                { id: 'carne', name: 'Carne bianca', qtyF: '100g', qtyP: '150g', items: ['Pollo', 'Tacchino', 'Vitello', 'Manzo', 'Coniglio', 'Puledro'] },
                { id: 'pesce', name: 'Pesce magro', qtyF: '200g', qtyP: '250g', items: ['Orata', 'Branzino', 'Merluzzo', 'Sogliola', 'Rombo', 'Tonno x2'] },
                { id: 'crostacei', name: 'Crostacei/Molluschi', qtyF: '200g', qtyP: '250g', items: ['Gamberi', 'Scampi', 'Cozze', 'Vongole', 'Seppie', 'Calamari'] },
                { id: 'affettato', name: 'Affettato magro', qtyF: '60g', qtyP: '80g', items: ['Bresaola', 'Prosciutto crudo', 'Carpaccio', 'Fesa tacchino'] },
                { id: 'formaggio', name: 'Formaggio magro', qtyF: '60g', qtyP: '80g', items: ['Asiago', 'Primo sale', 'Feta', 'Trenta'] },
                { id: 'uova', name: 'Uova sode', qtyF: '2', qtyP: '2', items: [] }
            ]
        },
        cena: {
            carbo: [
                { id: 'pasta', name: 'Pasta integrale', qtyF: '50-60g', qtyP: '80-100g' },
                { id: 'riso', name: 'Riso integrale', qtyF: '50-60g', qtyP: '80-100g' },
                { id: 'minestrone', name: 'Minestrone', qtyF: '100-150g', qtyP: '100-150g' }
            ],
            verduraTipo: ['Insalata', 'Verdura cotta', 'Insalata + cotta'],
            proteina: [
                { id: 'carne', name: 'Carne bianca', qtyF: '100g', qtyP: '150g', items: ['Pollo', 'Tacchino', 'Vitello', 'Manzo', 'Coniglio', 'Puledro'] },
                { id: 'pesce', name: 'Pesce magro', qtyF: '200g', qtyP: '250g', items: ['Orata', 'Branzino', 'Merluzzo', 'Sogliola', 'Rombo', 'Tonno x1'] },
                { id: 'crostacei', name: 'Crostacei/Molluschi', qtyF: '200g', qtyP: '250g', items: ['Gamberi', 'Scampi', 'Cozze', 'Vongole', 'Seppie', 'Calamari'] },
                { id: 'affettato', name: 'Affettato magro', qtyF: '60g', qtyP: '80g', items: ['Bresaola', 'Prosciutto crudo', 'Carpaccio', 'Fesa tacchino'] },
                { id: 'formaggio', name: 'Formaggio magro', qtyF: '60g', qtyP: '80g', items: ['Asiago', 'Primo sale', 'Feta', 'Trenta'] },
                { id: 'uova', name: 'Uovo sodo', qtyF: '1', qtyP: '1', items: [] }
            ]
        }
    };

    const BADGES = [
        { id: 'first_day', name: 'Primo giorno', emoji: '1', check: d => d.totalDays >= 1 },
        { id: 'week_1', name: '1 settimana', emoji: '7', check: d => d.totalDays >= 7 },
        { id: 'week_4', name: '1 mese', emoji: '30', check: d => d.totalDays >= 30 },
        { id: 'streak_3', name: 'Streak 3', emoji: 'S3', check: d => d.bestStreak >= 3 },
        { id: 'streak_7', name: 'Streak 7', emoji: 'S7', check: d => d.bestStreak >= 7 },
        { id: 'streak_14', name: 'Streak 14', emoji: 'S14', check: d => d.bestStreak >= 14 },
        { id: 'kg_1', name: '-1 kg', emoji: '-1', check: d => d.lost >= 1 },
        { id: 'kg_3', name: '-3 kg', emoji: '-3', check: d => d.lost >= 3 },
        { id: 'kg_5', name: '-5 kg', emoji: '-5', check: d => d.lost >= 5 }
    ];

    const LEVELS = [
        { name: 'Principiante', pts: 0 },
        { name: 'Apprendista', pts: 50 },
        { name: 'Guerriero', pts: 150 },
        { name: 'Campione', pts: 300 },
        { name: 'Leggenda', pts: 500 }
    ];

    const MOTIVATIONS = [
        "Ogni giorno e un passo verso il tuo obiettivo!",
        "La costanza batte sempre il talento.",
        "Sei piu forte di quanto pensi!",
        "Il tuo corpo ti ringraziera.",
        "Non mollare, sei sulla strada giusta!",
        "Piccoli progressi portano a grandi risultati.",
        "Oggi e il giorno perfetto per continuare!",
        "La disciplina e il ponte tra obiettivi e risultati.",
        "Credi in te stesso, ce la stai facendo!",
        "Ogni scelta sana conta."
    ];

    const MEAL_NAMES = {
        colazione: 'Colazione',
        mezzaMattina: 'Mezza Mattinata',
        pranzo: 'Pranzo',
        pomeriggio: 'Pomeriggio',
        cena: 'Cena'
    };

    // State
    let state = { currentUser: null, users: {}, theme: 'light' };
    let viewingDate = new Date();

    function createNewUser() {
        return {
            startDate: null,
            startWeight: null,
            goalWeight: null,
            targetWeeks: null,
            currentWeight: null,
            weightHistory: [],
            points: 0,
            streak: 0,
            bestStreak: 0,
            totalDays: 0,
            photo: null,
            prefs: {},
            days: {},
            visits: []
        };
    }

    function loadState() {
        try {
            const saved = localStorage.getItem('nunziaDietApp');
            if (saved) state = JSON.parse(saved);
        } catch (e) {
            console.log('Reset state');
            state = { currentUser: null, users: {}, theme: 'light' };
        }
        applyTheme();
        updateUserAvatars();
    }

    function saveState() {
        localStorage.setItem('nunziaDietApp', JSON.stringify(state));
    }

    function getUser() {
        return state.users[state.currentUser];
    }

    function formatDate(date) {
        return date.toISOString().split('T')[0];
    }

    function getToday() {
        return formatDate(new Date());
    }

    function getViewingDateStr() {
        return formatDate(viewingDate);
    }

    function isToday() {
        return getViewingDateStr() === getToday();
    }

    function getDayData(dateStr) {
        const user = getUser();
        if (!dateStr) dateStr = getViewingDateStr();
        if (!user.days[dateStr]) {
            user.days[dateStr] = { water: 0, activity: false, meals: {}, done: false };
        }
        return user.days[dateStr];
    }

    function isPaolo() {
        return state.currentUser === 'Paolo';
    }

    // Theme
    function toggleTheme() {
        state.theme = state.theme === 'light' ? 'dark' : 'light';
        applyTheme();
        saveState();
        haptic();
    }

    function applyTheme() {
        document.body.setAttribute('data-theme', state.theme);
        document.getElementById('theme-btn').textContent = state.theme === 'light' ? 'L' : 'D';
        document.getElementById('theme-color-meta').content = state.theme === 'light' ? '#F8FAFC' : '#0F172A';
    }

    // Haptic feedback
    function haptic() {
        if (navigator.vibrate) {
            navigator.vibrate(10);
        }
    }

    // Photo handling
    function handlePhotoUpload(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('photo-preview-img');
                img.src = e.target.result;
                img.classList.remove('hidden');
                document.getElementById('photo-placeholder').classList.add('hidden');

                if (state.currentUser && state.users[state.currentUser]) {
                    state.users[state.currentUser].photo = e.target.result;
                    saveState();
                    updateUserAvatars();
                }
            };
            reader.readAsDataURL(file);
        }
    }

    function updateUserAvatars() {
        renderUserSelection();
        updateHeaderUser();
    }

    function updateHeaderUser() {
        const headerUser = document.getElementById('header-user');
        const headerName = document.getElementById('header-name');
        const headerAvatar = document.getElementById('header-avatar');

        if (!state.currentUser) {
            headerUser.style.display = 'none';
            return;
        }

        headerUser.style.display = 'flex';
        const user = getUser();

        headerName.textContent = state.currentUser;

        if (user && user.photo) {
            headerAvatar.innerHTML = `<img src="${user.photo}">`;
        } else {
            headerAvatar.innerHTML = state.currentUser[0].toUpperCase();
        }
    }

    function initDefaultUsers() {
        // Create default users if they don't exist
        if (!state.users['Paolo']) {
            state.users['Paolo'] = createNewUser();
        }
        // Paolo is always admin
        state.users['Paolo'].isAdmin = true;

        if (!state.users['Flora']) {
            state.users['Flora'] = createNewUser();
        }
        saveState();
    }

    function ensureAdminExists() {
        // Make sure at least Paolo exists and is admin
        if (state.users['Paolo']) {
            state.users['Paolo'].isAdmin = true;
            saveState();
        }
    }

    function renderUserSelection() {
        const container = document.getElementById('user-select-container');
        if (!container) return;

        // Ensure default users exist
        if (Object.keys(state.users).length === 0) {
            initDefaultUsers();
        }

        const userNames = Object.keys(state.users);

        container.innerHTML = userNames.map(name => {
            const user = state.users[name];
            const hasPhoto = user && user.photo;
            const avatarContent = hasPhoto
                ? `<img src="${user.photo}">`
                : name[0].toUpperCase();
            const isAdmin = user && user.isAdmin;

            return `
                <button class="user-btn" onclick="selectUser('${name}')">
                    <div class="user-avatar">${avatarContent}</div>
                    <span>${name}${isAdmin ? ' *' : ''}</span>
                </button>
            `;
        }).join('');
    }

    function isCurrentUserAdmin() {
        const user = getUser();
        return user && user.isAdmin === true;
    }

    function addNewUser() {
        if (!isCurrentUserAdmin()) {
            alert('Solo l\'admin puÃ² aggiungere utenti');
            return;
        }

        const newName = prompt('Inserisci il nome del nuovo utente:');

        if (!newName || newName.trim() === '') {
            return;
        }

        const trimmedName = newName.trim();

        if (state.users[trimmedName]) {
            alert('Questo utente esiste giÃ !');
            return;
        }

        state.users[trimmedName] = createNewUser();
        saveState();
        renderUserSelection();
        haptic();
        alert('Utente ' + trimmedName + ' creato! PuÃ² selezionarlo dalla schermata iniziale.');
    }

    // Screens
    function showScreen(name) {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById('screen-' + name).classList.remove('hidden');
    }

    function showTab(name) {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        event.target.classList.add('active');
        document.getElementById('tab-' + name).classList.remove('hidden');
        if (name === 'weekly') renderWeekly();
        if (name === 'history') renderHistory();
        if (name === 'profile') renderProfile();
    }

    // Day Navigation
    function changeDay(delta) {
        viewingDate.setDate(viewingDate.getDate() + delta);
        if (viewingDate > new Date()) {
            viewingDate = new Date();
        }
        haptic();
        updateDayNav();
        initDashboard();
    }

    function updateDayNav() {
        const today = new Date();
        today.setHours(0,0,0,0);
        const viewing = new Date(viewingDate);
        viewing.setHours(0,0,0,0);

        const diffDays = Math.floor((today - viewing) / 86400000);
        const dayLabel = document.getElementById('current-day-label');
        const todayIndicator = document.getElementById('today-indicator');

        if (diffDays === 0) {
            dayLabel.textContent = 'Oggi';
            todayIndicator.classList.add('hidden');
        } else if (diffDays === 1) {
            dayLabel.textContent = 'Ieri';
            todayIndicator.classList.add('hidden');
        } else {
            const opts = { weekday: 'short', day: 'numeric', month: 'short' };
            dayLabel.textContent = viewingDate.toLocaleDateString('it-IT', opts);
            todayIndicator.classList.add('hidden');
        }

        document.getElementById('next-day-btn').disabled = isToday();
    }

    // User selection
    function selectUser(name) {
        state.currentUser = name;
        updateHeaderUser();
        if (!state.users[name]) {
            state.users[name] = createNewUser();
            saveState();
            showScreen('setup');
            setupPhotoPreview();
        } else {
            saveState();
            showScreen('dashboard');
            viewingDate = new Date();
            updateDayNav();
            initDashboard();
        }
        haptic();
    }

    function setupPhotoPreview() {
        const user = getUser();
        const img = document.getElementById('photo-preview-img');
        const placeholder = document.getElementById('photo-placeholder');

        if (user && user.photo) {
            img.src = user.photo;
            img.classList.remove('hidden');
            placeholder.classList.add('hidden');
        } else {
            img.classList.add('hidden');
            placeholder.classList.remove('hidden');
        }
    }

    function saveSetup() {
        const user = getUser();
        user.startDate = document.getElementById('start-date').value;
        user.startWeight = parseFloat(document.getElementById('start-weight').value);
        user.goalWeight = parseFloat(document.getElementById('goal-weight').value);
        user.targetWeeks = parseInt(document.getElementById('target-weeks').value);
        user.currentWeight = user.startWeight;
        user.weightHistory = [{ date: user.startDate, weight: user.startWeight }];

        const img = document.getElementById('photo-preview-img');
        if (img.src && !img.classList.contains('hidden')) {
            user.photo = img.src;
        }

        saveState();
        updateUserAvatars();
        showScreen('dashboard');
        viewingDate = new Date();
        updateDayNav();
        initDashboard();
    }

    // Dashboard
    function initDashboard() {
        getDayData();
        updateStats();
        renderWater();
        renderActivity();
        renderMeals();
        updateWeightDisplay();
    }

    function updateStats() {
        const user = getUser();
        const dayNum = user.startDate ? Math.floor((new Date() - new Date(user.startDate)) / 86400000) + 1 : 1;
        document.getElementById('day-counter').textContent = dayNum;
        document.getElementById('streak-counter').textContent = user.streak;
        document.getElementById('points-counter').textContent = user.points;
    }

    // Daily Weight
    function updateWeightDisplay() {
        const user = getUser();
        const display = document.getElementById('weight-display');
        const input = document.getElementById('daily-weight');

        if (user.currentWeight) {
            display.textContent = 'Ultimo peso: ' + user.currentWeight + ' kg';
            input.placeholder = user.currentWeight;
        } else {
            display.textContent = 'Nessun peso registrato';
        }
    }

    function saveDailyWeight() {
        const input = document.getElementById('daily-weight');
        const weight = parseFloat(input.value);

        if (!weight || weight < 30 || weight > 200) {
            alert('Inserisci un peso valido');
            return;
        }

        const user = getUser();
        const today = getToday();

        user.currentWeight = weight;

        // Update or add to weight history
        const existing = user.weightHistory.findIndex(w => w.date === today);
        if (existing >= 0) {
            user.weightHistory[existing].weight = weight;
        } else {
            user.weightHistory.push({ date: today, weight: weight });
        }

        input.value = '';
        saveState();
        updateWeightDisplay();
        haptic();

        // Show quick feedback
        const display = document.getElementById('weight-display');
        display.textContent = 'Peso salvato: ' + weight + ' kg';
        display.style.color = 'var(--success)';
        setTimeout(() => {
            display.style.color = '';
            updateWeightDisplay();
        }, 1500);
    }

    // Water
    function renderWater() {
        const data = getDayData();
        const el = document.getElementById('water-tracker');
        el.innerHTML = '';
        for (let i = 0; i < 4; i++) {
            const drop = document.createElement('div');
            drop.className = 'water-drop' + (i < data.water ? ' filled' : '');
            drop.textContent = '0.5';
            drop.onclick = () => {
                data.water = i + 1;
                saveState();
                renderWater();
                haptic();
            };
            el.appendChild(drop);
        }
        const total = document.createElement('span');
        total.className = 'water-total';
        total.textContent = (data.water * 0.5) + ' L';
        el.appendChild(total);
    }

    // Activity
    function renderActivity() {
        const data = getDayData();
        document.getElementById('activity-toggle').classList.toggle('active', data.activity);
        document.getElementById('activity-switch').classList.toggle('active', data.activity);
    }

    function toggleActivity() {
        const data = getDayData();
        data.activity = !data.activity;
        saveState();
        renderActivity();
        haptic();
    }

    // Meals
    function renderMeals() {
        const container = document.getElementById('meals-container');
        container.innerHTML = '';
        container.appendChild(createMealCard('colazione', 'Colazione'));
        container.appendChild(createMealCard('mezzaMattina', 'Mezza Mattinata'));
        container.appendChild(createMealCard('pranzo', 'Pranzo'));
        container.appendChild(createMealCard('pomeriggio', 'Pomeriggio'));
        container.appendChild(createMealCard('cena', 'Cena'));
    }

    function getMealData(mealKey) {
        const data = getDayData();
        if (!data.meals[mealKey]) data.meals[mealKey] = { sel: {}, status: null, note: '' };
        return data.meals[mealKey];
    }

    function setMealSel(mealKey, key, value) {
        const meal = getMealData(mealKey);
        meal.sel[key] = value;
        const user = getUser();
        if (!user.prefs[mealKey]) user.prefs[mealKey] = {};
        user.prefs[mealKey][key] = value;
        saveState();
        renderMeals();
        haptic();
    }

    function setMealStatus(mealKey, status) {
        getMealData(mealKey).status = status;
        saveState();
        renderMeals();
        haptic();
    }

    function setMealNote(mealKey, note) {
        getMealData(mealKey).note = note;
        saveState();
    }

    function toggleVerdura(mealKey, tipo, verdura) {
        const meal = getMealData(mealKey);
        if (!meal.sel.verdureItems) meal.sel.verdureItems = { insalate: [], cotte: [] };

        const arr = tipo === 'insalata' ? meal.sel.verdureItems.insalate : meal.sel.verdureItems.cotte;
        const idx = arr.indexOf(verdura);
        if (idx >= 0) {
            arr.splice(idx, 1);
        } else {
            arr.push(verdura);
        }
        saveState();
        renderMeals();
        haptic();
    }

    function isVerduraSelected(mealKey, tipo, verdura) {
        const meal = getMealData(mealKey);
        if (!meal.sel.verdureItems) return false;
        const arr = tipo === 'insalata' ? meal.sel.verdureItems.insalate : meal.sel.verdureItems.cotte;
        return arr.includes(verdura);
    }

    function getPref(mealKey, key) {
        const user = getUser();
        return user.prefs[mealKey] ? user.prefs[mealKey][key] : null;
    }

    function btnGroup(mealKey, key, options, selected) {
        return `<div class="choice-buttons">${options.map(o =>
            `<button class="choice-btn${selected === o ? ' selected' : ''}" onclick="setMealSel('${mealKey}','${key}','${o}')">${o}</button>`
        ).join('')}</div>`;
    }

    function verdureSection(mealKey, verduraTipo) {
        let html = '';
        const showInsalate = verduraTipo === 'Insalata' || verduraTipo === 'Insalata + cotta';
        const showCotte = verduraTipo === 'Verdura cotta' || verduraTipo === 'Insalata + cotta';

        if (showInsalate) {
            html += `<div class="detail-section">
                <div class="choice-label">Insalata a volonta</div>
                <div class="choice-buttons">${INSALATE.map(v =>
                    `<button class="choice-btn small${isVerduraSelected(mealKey, 'insalata', v) ? ' selected' : ''}" onclick="toggleVerdura('${mealKey}','insalata','${v}')">${v}</button>`
                ).join('')}</div>
            </div>`;
        }

        if (showCotte) {
            html += `<div class="detail-section">
                <div class="choice-label">Verdura cotta a volonta</div>
                <div class="choice-buttons">${VERDURE_COTTE.map(v =>
                    `<button class="choice-btn small${isVerduraSelected(mealKey, 'cotta', v) ? ' selected' : ''}" onclick="toggleVerdura('${mealKey}','cotta','${v}')">${v}</button>`
                ).join('')}</div>
            </div>`;
        }

        return html;
    }

    function statusBtns(mealKey, status) {
        return `<div class="meal-actions">
            <button class="meal-btn ok${status === 'ok' ? ' active' : ''}" onclick="setMealStatus('${mealKey}','ok')">OK</button>
            <button class="meal-btn skip${status === 'skip' ? ' active' : ''}" onclick="setMealStatus('${mealKey}','skip')">Salta</button>
            <button class="meal-btn sgarro${status === 'sgarro' ? ' active' : ''}" onclick="setMealStatus('${mealKey}','sgarro')">Sgarro</button>
        </div>`;
    }

    function noteField(mealKey, note) {
        return `<div class="meal-note">
            <input type="text" placeholder="Note..." value="${note || ''}" onchange="setMealNote('${mealKey}', this.value)">
        </div>`;
    }

    function createMealCard(mealKey, mealName) {
        const m = getMealData(mealKey);
        const p = isPaolo();
        const card = document.createElement('div');
        card.className = 'meal-card' + (m.status ? ' saved' : '');

        let content = `<div class="meal-header"><span class="meal-time">${mealName}</span></div>`;

        if (mealKey === 'colazione' || mealKey === 'pomeriggio') {
            const foods = FOODS[mealKey];
            content += `
                <div class="choice-group">
                    <div class="choice-label">Bevanda</div>
                    ${btnGroup(mealKey, 'bevanda', foods.bevanda, m.sel.bevanda || getPref(mealKey, 'bevanda'))}
                </div>
                <div class="choice-group">
                    <div class="choice-label">Accompagnamento</div>
                    ${btnGroup(mealKey, 'accompagnamento', foods.accompagnamento, m.sel.accompagnamento || getPref(mealKey, 'accompagnamento'))}
                </div>
            `;
        } else if (mealKey === 'mezzaMattina') {
            content += `
                <div class="choice-group">
                    <div class="choice-label">Proteina</div>
                    ${btnGroup(mealKey, 'proteina', FOODS.mezzaMattina.proteina, m.sel.proteina || getPref(mealKey, 'proteina'))}
                </div>
            `;
        } else if (mealKey === 'pranzo') {
            let protDetail = '';
            if (m.sel.proteina) {
                const prot = FOODS.pranzo.proteina.find(x => x.id === m.sel.proteina);
                if (prot && prot.items.length > 0) {
                    protDetail = `<div class="detail-section">
                        <div class="choice-label">${prot.name} - scegli tipo</div>
                        <div class="choice-buttons">${prot.items.map(i =>
                            `<button class="choice-btn small${m.sel.protItem === i ? ' selected' : ''}" onclick="setMealSel('pranzo','protItem','${i}')">${i}</button>`
                        ).join('')}</div>
                        <div class="qty-note">Quantita: ${p ? prot.qtyP : prot.qtyF}</div>
                    </div>`;
                }
            }
            const verduraTipo = m.sel.verduraTipo || getPref('pranzo', 'verduraTipo');
            content += `
                <div class="choice-group">
                    <div class="choice-label">Tipo verdura</div>
                    ${btnGroup('pranzo', 'verduraTipo', FOODS.pranzo.verduraTipo, verduraTipo)}
                </div>
                ${verduraTipo ? verdureSection('pranzo', verduraTipo) : ''}
                <div class="choice-group">
                    <div class="choice-label">Proteina</div>
                    <div class="choice-buttons">${FOODS.pranzo.proteina.map(pr =>
                        `<button class="choice-btn${m.sel.proteina === pr.id ? ' selected' : ''}" onclick="setMealSel('pranzo','proteina','${pr.id}');setMealSel('pranzo','protItem',null)">${pr.name}<br><small>${p ? pr.qtyP : pr.qtyF}</small></button>`
                    ).join('')}</div>
                </div>
                ${protDetail}
            `;
        } else if (mealKey === 'cena') {
            let protDetail = '';
            if (m.sel.proteina) {
                const prot = FOODS.cena.proteina.find(x => x.id === m.sel.proteina);
                if (prot && prot.items.length > 0) {
                    protDetail = `<div class="detail-section">
                        <div class="choice-label">${prot.name} - scegli tipo</div>
                        <div class="choice-buttons">${prot.items.map(i =>
                            `<button class="choice-btn small${m.sel.protItem === i ? ' selected' : ''}" onclick="setMealSel('cena','protItem','${i}')">${i}</button>`
                        ).join('')}</div>
                        <div class="qty-note">Quantita: ${p ? prot.qtyP : prot.qtyF}</div>
                    </div>`;
                }
            }
            const verduraTipoCena = m.sel.verduraTipo || getPref('cena', 'verduraTipo');
            content += `
                <div class="choice-group">
                    <div class="choice-label">Carboidrato</div>
                    <div class="choice-buttons">${FOODS.cena.carbo.map(c =>
                        `<button class="choice-btn${m.sel.carbo === c.id ? ' selected' : ''}" onclick="setMealSel('cena','carbo','${c.id}')">${c.name}<br><small>${p ? c.qtyP : c.qtyF}</small></button>`
                    ).join('')}</div>
                </div>
                <div class="choice-group">
                    <div class="choice-label">Tipo verdura</div>
                    ${btnGroup('cena', 'verduraTipo', FOODS.cena.verduraTipo, verduraTipoCena)}
                </div>
                ${verduraTipoCena ? verdureSection('cena', verduraTipoCena) : ''}
                <div class="choice-group">
                    <div class="choice-label">Proteina</div>
                    <div class="choice-buttons">${FOODS.cena.proteina.map(pr =>
                        `<button class="choice-btn${m.sel.proteina === pr.id ? ' selected' : ''}" onclick="setMealSel('cena','proteina','${pr.id}');setMealSel('cena','protItem',null)">${pr.name}<br><small>${p ? pr.qtyP : pr.qtyF}</small></button>`
                    ).join('')}</div>
                </div>
                ${protDetail}
            `;
        }

        content += statusBtns(mealKey, m.status);
        content += noteField(mealKey, m.note);

        card.innerHTML = content;
        return card;
    }

    // Copy previous day
    function copyPreviousDay() {
        const yesterday = new Date(viewingDate);
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = formatDate(yesterday);
        const user = getUser();

        if (!user.days[yesterdayStr]) {
            alert('Nessun dato per ieri!');
            return;
        }

        const yesterdayData = user.days[yesterdayStr];
        const todayData = getDayData();

        todayData.water = yesterdayData.water;
        todayData.activity = yesterdayData.activity;
        todayData.meals = JSON.parse(JSON.stringify(yesterdayData.meals));
        // Reset status
        Object.keys(todayData.meals).forEach(k => {
            todayData.meals[k].status = null;
            todayData.meals[k].note = '';
        });
        todayData.done = false;

        saveState();
        initDashboard();
        haptic();
    }

    // Save day
    function saveDay() {
        const data = getDayData();
        const meals = ['colazione', 'mezzaMattina', 'pranzo', 'pomeriggio', 'cena'];
        const allSet = meals.every(k => data.meals[k] && data.meals[k].status);

        if (!allSet) {
            alert('Completa tutti i pasti prima di salvare!');
            return;
        }

        const user = getUser();
        const hasSgarro = meals.some(k => data.meals[k].status === 'sgarro');
        data.done = true;

        let bonus = 0;
        if (hasSgarro) {
            user.streak = 0;
        } else {
            user.streak++;
            bonus += 10;
            if (data.water >= 4) bonus += 5;
            if (data.activity) bonus += 5;
            user.points += bonus;
        }

        user.totalDays++;
        if (user.streak > user.bestStreak) user.bestStreak = user.streak;

        saveState();
        updateStats();
        haptic();

        // Show success animation
        if (!hasSgarro) {
            showSuccess('Ottimo lavoro!', '+' + bonus + ' punti');
            createConfetti();
        } else {
            showSuccess('Giornata salvata', 'Domani si riparte!');
        }
    }

    // Success animation
    function showSuccess(title, points) {
        document.getElementById('success-title').textContent = title;
        document.getElementById('success-points').textContent = points;
        document.getElementById('success-overlay').classList.add('show');
        setTimeout(hideSuccess, 2000);
    }

    function hideSuccess() {
        document.getElementById('success-overlay').classList.remove('show');
    }

    // Confetti
    function createConfetti() {
        const colors = ['#5AC8FA', '#34D399', '#FBBF24', '#F87171', '#A78BFA'];
        for (let i = 0; i < 50; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.width = (Math.random() * 10 + 5) + 'px';
            confetti.style.height = confetti.style.width;
            confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
            confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
            confetti.style.animationDelay = Math.random() * 0.5 + 's';
            document.body.appendChild(confetti);
            setTimeout(() => confetti.remove(), 4000);
        }
    }

    // Weekly
    function renderWeekly() {
        const user = getUser();
        const grid = document.getElementById('week-grid');
        grid.innerHTML = '';
        const today = new Date();
        const dayNames = ['D', 'L', 'M', 'M', 'G', 'V', 'S'];
        let okCount = 0, sgarroCount = 0;

        for (let i = 6; i >= 0; i--) {
            const d = new Date(today);
            d.setDate(d.getDate() - i);
            const dateStr = formatDate(d);
            const dayData = user.days[dateStr];

            let status = '-';
            if (dayData && dayData.done) {
                const hasSgarro = Object.values(dayData.meals).some(m => m.status === 'sgarro');
                status = hasSgarro ? 'x' : 'v';
                hasSgarro ? sgarroCount++ : okCount++;
            }

            const el = document.createElement('div');
            el.className = 'week-day' + (i === 0 ? ' today' : '');
            el.innerHTML = `<div class="week-day-name">${dayNames[d.getDay()]}</div><div class="week-day-num">${d.getDate()}</div><div class="week-day-status">${status}</div>`;
            el.onclick = () => {
                viewingDate = new Date(d);
                updateDayNav();
                initDashboard();
                showTabByName('daily');
            };
            grid.appendChild(el);
        }

        document.getElementById('week-ok').textContent = okCount;
        document.getElementById('week-sgarro').textContent = sgarroCount;
        const total = okCount + sgarroCount;
        document.getElementById('week-adherence').textContent = total > 0 ? Math.round(okCount / total * 100) + '%' : '-';

        document.getElementById('start-w-label').textContent = 'Inizio: ' + (user.startWeight || '--') + ' kg';
        document.getElementById('goal-w-label').textContent = 'Obiettivo: ' + (user.goalWeight || '--') + ' kg';
        document.getElementById('current-weight').value = user.currentWeight || '';
        updateWeightProgress();
        renderWeightChart();

        document.getElementById('motivation-text').textContent = '"' + MOTIVATIONS[Math.floor(Math.random() * MOTIVATIONS.length)] + '"';
    }

    function showTabByName(name) {
        document.querySelectorAll('.nav-tab').forEach((t, i) => {
            t.classList.toggle('active', t.textContent.toLowerCase().includes(name.substring(0, 4)));
        });
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        document.getElementById('tab-' + name).classList.remove('hidden');
    }

    function updateWeight() {
        const user = getUser();
        const newWeight = parseFloat(document.getElementById('current-weight').value);
        user.currentWeight = newWeight;

        // Add to history
        const today = getToday();
        const existing = user.weightHistory.findIndex(w => w.date === today);
        if (existing >= 0) {
            user.weightHistory[existing].weight = newWeight;
        } else {
            user.weightHistory.push({ date: today, weight: newWeight });
        }

        saveState();
        updateWeightProgress();
        renderWeightChart();
    }

    function updateWeightProgress() {
        const user = getUser();
        if (!user.startWeight || !user.goalWeight || !user.currentWeight) return;
        const tolose = user.startWeight - user.goalWeight;
        const lost = user.startWeight - user.currentWeight;
        const pct = Math.min(100, Math.max(0, (lost / tolose) * 100));
        document.getElementById('weight-progress').style.width = pct + '%';
        document.getElementById('weight-diff').textContent = lost.toFixed(1) + ' kg persi su ' + tolose.toFixed(1) + ' kg obiettivo';
    }

    // Weight Chart
    function renderWeightChart() {
        const canvas = document.getElementById('weight-canvas');
        const ctx = canvas.getContext('2d');
        const user = getUser();

        // Set canvas size
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width * 2;
        canvas.height = rect.height * 2;
        ctx.scale(2, 2);

        const width = rect.width;
        const height = rect.height;

        // Clear
        ctx.clearRect(0, 0, width, height);

        if (!user.weightHistory || user.weightHistory.length < 2) {
            ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-secondary');
            ctx.font = '12px -apple-system';
            ctx.textAlign = 'center';
            ctx.fillText('Aggiungi piu pesate per vedere il grafico', width / 2, height / 2);
            return;
        }

        const data = user.weightHistory.slice(-14); // Last 14 entries
        const weights = data.map(d => d.weight);
        const minW = Math.min(...weights) - 1;
        const maxW = Math.max(...weights) + 1;

        const padding = { left: 35, right: 10, top: 10, bottom: 20 };
        const chartW = width - padding.left - padding.right;
        const chartH = height - padding.top - padding.bottom;

        // Draw grid lines
        ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--border');
        ctx.lineWidth = 0.5;
        for (let i = 0; i <= 4; i++) {
            const y = padding.top + (chartH / 4) * i;
            ctx.beginPath();
            ctx.moveTo(padding.left, y);
            ctx.lineTo(width - padding.right, y);
            ctx.stroke();

            // Labels
            const weight = maxW - ((maxW - minW) / 4) * i;
            ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-secondary');
            ctx.font = '10px -apple-system';
            ctx.textAlign = 'right';
            ctx.fillText(weight.toFixed(1), padding.left - 5, y + 3);
        }

        // Draw line
        ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--accent');
        ctx.lineWidth = 2;
        ctx.beginPath();

        data.forEach((d, i) => {
            const x = padding.left + (chartW / (data.length - 1)) * i;
            const y = padding.top + chartH - ((d.weight - minW) / (maxW - minW)) * chartH;

            if (i === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        });
        ctx.stroke();

        // Draw points (normal ones first)
        data.forEach((d, i) => {
            const x = padding.left + (chartW / (data.length - 1)) * i;
            const y = padding.top + chartH - ((d.weight - minW) / (maxW - minW)) * chartH;

            if (!d.isVisit) {
                ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--accent');
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fill();
            }
        });

        // Draw visit points (larger, different color)
        data.forEach((d, i) => {
            const x = padding.left + (chartW / (data.length - 1)) * i;
            const y = padding.top + chartH - ((d.weight - minW) / (maxW - minW)) * chartH;

            if (d.isVisit) {
                // Outer ring
                ctx.strokeStyle = '#FF6B6B';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(x, y, 7, 0, Math.PI * 2);
                ctx.stroke();

                // Inner fill
                ctx.fillStyle = '#FF6B6B';
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fill();
            }
        });

        // Goal line
        if (user.goalWeight >= minW && user.goalWeight <= maxW) {
            const goalY = padding.top + chartH - ((user.goalWeight - minW) / (maxW - minW)) * chartH;
            ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--success');
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(padding.left, goalY);
            ctx.lineTo(width - padding.right, goalY);
            ctx.stroke();
            ctx.setLineDash([]);
        }
    }

    function saveDietologVisit() {
        const user = getUser();
        const visitWeight = parseFloat(document.getElementById('visit-weight').value);
        const visitDate = document.getElementById('visit-date').value;

        user.visits.push({
            date: visitDate,
            weight: visitWeight || null,
            outcome: document.getElementById('visit-outcome').value,
            notes: document.getElementById('visit-notes').value
        });

        // Update current weight if provided
        if (visitWeight) {
            user.currentWeight = visitWeight;
            // Add to weight history with visit flag
            const existing = user.weightHistory.findIndex(w => w.date === visitDate);
            if (existing >= 0) {
                user.weightHistory[existing] = { date: visitDate, weight: visitWeight, isVisit: true };
            } else {
                user.weightHistory.push({ date: visitDate, weight: visitWeight, isVisit: true });
            }
            document.getElementById('current-weight').value = visitWeight;
        }

        // Clear form
        document.getElementById('visit-date').value = '';
        document.getElementById('visit-weight').value = '';
        document.getElementById('visit-outcome').value = '';
        document.getElementById('visit-notes').value = '';

        saveState();
        renderWeightChart();
        updateWeightProgress();
        alert('Visita salvata!');
        haptic();
    }

    // History
    function getWeekNumber(date, startDate) {
        const start = new Date(startDate);
        const diff = Math.floor((date - start) / (1000 * 60 * 60 * 24));
        return Math.floor(diff / 7) + 1;
    }

    function renderHistory() {
        const user = getUser();
        const container = document.getElementById('history-container');
        container.innerHTML = '';

        if (!user.startDate) {
            container.innerHTML = '<p style="text-align:center;color:var(--text-secondary);padding:20px;">Nessun dato salvato</p>';
            return;
        }

        // Collect all days
        const days = Object.keys(user.days)
            .filter(d => user.days[d].done)
            .map(dateStr => ({ type: 'day', date: dateStr, data: user.days[dateStr] }));

        // Collect visits
        const visits = (user.visits || [])
            .filter(v => v.date)
            .map(v => ({ type: 'visit', date: v.date, data: v }));

        if (days.length === 0 && visits.length === 0) {
            container.innerHTML = '<p style="text-align:center;color:var(--text-secondary);padding:20px;">Nessun dato salvato</p>';
            return;
        }

        // Group days by week
        const weeks = {};
        days.forEach(day => {
            const weekNum = getWeekNumber(new Date(day.date), user.startDate);
            if (!weeks[weekNum]) {
                weeks[weekNum] = { days: [], visits: [] };
            }
            weeks[weekNum].days.push(day);
        });

        // Assign visits to weeks
        visits.forEach(visit => {
            const weekNum = getWeekNumber(new Date(visit.date), user.startDate);
            if (!weeks[weekNum]) {
                weeks[weekNum] = { days: [], visits: [] };
            }
            weeks[weekNum].visits.push(visit);
        });

        // Sort weeks descending
        const sortedWeeks = Object.keys(weeks).map(Number).sort((a, b) => b - a);

        sortedWeeks.forEach(weekNum => {
            const week = weeks[weekNum];

            // Sort days in week
            week.days.sort((a, b) => b.date.localeCompare(a.date));

            // Calculate week stats
            const okDays = week.days.filter(d => !Object.values(d.data.meals).some(m => m.status === 'sgarro')).length;
            const sgarroDays = week.days.length - okDays;

            // Week start/end dates
            const weekDates = week.days.map(d => new Date(d.date)).sort((a, b) => a - b);
            const startDateLabel = weekDates.length > 0 ? weekDates[0].toLocaleDateString('it-IT', { day: 'numeric', month: 'short' }) : '';
            const endDateLabel = weekDates.length > 0 ? weekDates[weekDates.length - 1].toLocaleDateString('it-IT', { day: 'numeric', month: 'short' }) : '';
            const periodLabel = startDateLabel === endDateLabel ? startDateLabel : `${startDateLabel} - ${endDateLabel}`;

            // Create week container
            const weekEl = document.createElement('div');
            weekEl.className = 'history-week';
            weekEl.innerHTML = `
                <div class="history-week-header" onclick="toggleWeek(this)">
                    <div class="history-week-title">
                        <span class="history-week-name">W${weekNum}</span>
                        <span class="history-week-period">${periodLabel}</span>
                    </div>
                    <div class="history-week-stats">
                        <span style="color:var(--success);">${okDays} OK</span>
                        <span style="color:var(--error);">${sgarroDays} X</span>
                        <span class="history-week-arrow">+</span>
                    </div>
                </div>
                <div class="history-week-content" style="display:none;"></div>
            `;

            const contentEl = weekEl.querySelector('.history-week-content');

            // Add days
            week.days.forEach(event => {
                const date = new Date(event.date);
                const dateLabel = date.toLocaleDateString('it-IT', { weekday: 'short', day: 'numeric' });
                const dayData = event.data;

                const sgarroMeals = [];
                let dayNotes = [];

                ['colazione', 'mezzaMattina', 'pranzo', 'pomeriggio', 'cena'].forEach(mealKey => {
                    const meal = dayData.meals[mealKey];
                    if (meal) {
                        if (meal.status === 'sgarro') sgarroMeals.push(MEAL_NAMES[mealKey]);
                        if (meal.note && meal.note.trim()) dayNotes.push(meal.note);
                    }
                });

                const hasSgarro = sgarroMeals.length > 0;

                const dayEl = document.createElement('div');
                dayEl.className = 'history-day-mini';
                dayEl.style.cursor = 'pointer';
                dayEl.innerHTML = `
                    <span class="history-day-mini-date">${dateLabel}</span>
                    <span class="history-day-mini-info">${hasSgarro ? 'X ' + sgarroMeals.join(', ') : (dayNotes.length > 0 ? dayNotes[0].substring(0, 20) + '...' : '')}</span>
                    <span class="history-day-status ${hasSgarro ? 'sgarro' : 'ok'}">${hasSgarro ? 'X' : 'OK'}</span>
                `;
                dayEl.onclick = (e) => { e.stopPropagation(); showDayDetail(event.date); };
                contentEl.appendChild(dayEl);
            });

            container.appendChild(weekEl);

            // Add visits after week (if any)
            week.visits.forEach(visit => {
                const date = new Date(visit.date);
                const dateLabel = date.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'short' });
                const outcomeLabels = { positive: 'Positivo', neutral: 'Neutro', negative: 'Negativo' };
                const outcomeColors = { positive: 'var(--success)', neutral: 'var(--warning)', negative: 'var(--error)' };

                let visitHtml = '';
                if (visit.data.weight) {
                    visitHtml += `<div style="font-size:14px;font-weight:600;color:var(--accent);">Peso: ${visit.data.weight} kg</div>`;
                }
                if (visit.data.outcome) {
                    visitHtml += `<div style="font-size:12px;margin-top:4px;color:${outcomeColors[visit.data.outcome] || 'var(--text)'};">Esito: ${outcomeLabels[visit.data.outcome] || visit.data.outcome}</div>`;
                }
                if (visit.data.notes) {
                    visitHtml += `<div style="margin-top:6px;padding:8px;background:var(--bg);border-radius:6px;font-size:12px;color:var(--text);">${visit.data.notes}</div>`;
                }

                const visitEl = document.createElement('div');
                visitEl.className = 'history-visit';
                visitEl.innerHTML = `
                    <div class="history-visit-header">
                        <span style="font-size:11px;padding:4px 8px;background:var(--accent);color:#fff;border-radius:12px;">VISITA</span>
                        <span class="history-visit-date">${dateLabel}</span>
                    </div>
                    ${visitHtml}
                `;
                container.appendChild(visitEl);
            });
        });
    }

    function toggleWeek(header) {
        const content = header.nextElementSibling;
        const arrow = header.querySelector('.history-week-arrow');
        if (content.style.display === 'none') {
            content.style.display = 'block';
            arrow.textContent = '-';
        } else {
            content.style.display = 'none';
            arrow.textContent = '+';
        }
    }

    // Day Detail Modal
    function showDayDetail(dateStr) {
        const user = getUser();
        const dayData = user.days[dateStr];
        if (!dayData) return;

        const date = new Date(dateStr);
        const dateLabel = date.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

        document.getElementById('detail-modal-title').textContent = dateLabel;

        let html = '';

        // Summary section
        const hasSgarro = Object.values(dayData.meals).some(m => m.status === 'sgarro');
        html += `<div class="detail-section-card">
            <div class="detail-section-title">Riepilogo</div>
            <div class="detail-row">
                <span class="detail-row-label">Stato giornata</span>
                <span class="detail-meal-status ${hasSgarro ? 'sgarro' : 'ok'}">${hasSgarro ? 'SGARRO' : 'OK'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-row-label">Acqua</span>
                <span class="detail-row-value">${dayData.water * 0.5} L</span>
            </div>
            <div class="detail-row">
                <span class="detail-row-label">Attivita fisica</span>
                <span class="detail-row-value">${dayData.activity ? 'Si' : 'No'}</span>
            </div>
        </div>`;

        // Meals section
        ['colazione', 'mezzaMattina', 'pranzo', 'pomeriggio', 'cena'].forEach(mealKey => {
            const meal = dayData.meals[mealKey];
            if (!meal) return;

            html += `<div class="detail-section-card">
                <div class="detail-section-title" style="display:flex;justify-content:space-between;align-items:center;">
                    <span>${MEAL_NAMES[mealKey]}</span>
                    <span class="detail-meal-status ${meal.status}">${meal.status === 'ok' ? 'OK' : meal.status === 'sgarro' ? 'SGARRO' : 'SALTATO'}</span>
                </div>`;

            // Show selections
            if (meal.sel) {
                Object.entries(meal.sel).forEach(([key, value]) => {
                    if (!value || key === 'verdureItems') return;

                    let label = key;
                    if (key === 'bevanda') label = 'Bevanda';
                    else if (key === 'accompagnamento') label = 'Accompagnamento';
                    else if (key === 'proteina') label = 'Proteina';
                    else if (key === 'protItem') label = 'Tipo';
                    else if (key === 'carbo') label = 'Carboidrato';
                    else if (key === 'verduraTipo') label = 'Tipo verdura';

                    html += `<div class="detail-row">
                        <span class="detail-row-label">${label}</span>
                        <span class="detail-row-value">${value}</span>
                    </div>`;
                });

                // Show verdure items if present
                if (meal.sel.verdureItems) {
                    if (meal.sel.verdureItems.insalate && meal.sel.verdureItems.insalate.length > 0) {
                        html += `<div class="detail-row">
                            <span class="detail-row-label">Insalate</span>
                            <span class="detail-row-value">${meal.sel.verdureItems.insalate.join(', ')}</span>
                        </div>`;
                    }
                    if (meal.sel.verdureItems.cotte && meal.sel.verdureItems.cotte.length > 0) {
                        html += `<div class="detail-row">
                            <span class="detail-row-label">Verdure cotte</span>
                            <span class="detail-row-value">${meal.sel.verdureItems.cotte.join(', ')}</span>
                        </div>`;
                    }
                }
            }

            // Show note if present
            if (meal.note && meal.note.trim()) {
                html += `<div style="margin-top:8px;padding:8px;background:var(--card);border-radius:6px;font-size:12px;color:var(--text);border:1px solid var(--border);">
                    <strong>Note:</strong> ${meal.note}
                </div>`;
            }

            html += `</div>`;
        });

        document.getElementById('detail-modal-body').innerHTML = html;
        document.getElementById('detail-modal').classList.add('show');
        haptic();
    }

    function closeDetailModal() {
        document.getElementById('detail-modal').classList.remove('show');
    }

    // Export data
    function exportData() {
        const user = getUser();
        let csv = 'Data,Acqua(L),Attivita,Colazione,MezzaMattina,Pranzo,Pomeriggio,Cena,Esito\n';

        Object.keys(user.days).sort().forEach(dateStr => {
            const day = user.days[dateStr];
            if (!day.done) return;

            const hasSgarro = Object.values(day.meals).some(m => m.status === 'sgarro');
            const mealSummary = (mealKey) => {
                const m = day.meals[mealKey];
                if (!m) return '-';
                const sels = Object.values(m.sel || {}).filter(v => v).join('+');
                return `${sels || '-'}(${m.status})`;
            };

            csv += `${dateStr},${day.water * 0.5},${day.activity ? '1' : '0'},${mealSummary('colazione')},${mealSummary('mezzaMattina')},${mealSummary('pranzo')},${mealSummary('pomeriggio')},${mealSummary('cena')},${hasSgarro ? 'Sgarro' : 'OK'}\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `NunziaDiet_${state.currentUser}_${getToday()}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        haptic();
    }

    // Profile
    function renderProfile() {
        const user = getUser();

        const photoEl = document.getElementById('profile-photo');
        if (user.photo) {
            photoEl.innerHTML = `<img src="${user.photo}">`;
        } else {
            photoEl.innerHTML = state.currentUser[0];
        }

        document.getElementById('profile-name').textContent = state.currentUser + (user.isAdmin ? ' (Admin)' : '');
        document.getElementById('total-days').textContent = user.totalDays;
        document.getElementById('best-streak').textContent = user.bestStreak;

        const level = LEVELS.slice().reverse().find(l => user.points >= l.pts);
        document.getElementById('profile-level').textContent = level.name;

        const lost = (user.startWeight && user.currentWeight) ? user.startWeight - user.currentWeight : 0;
        const badgeData = { totalDays: user.totalDays, bestStreak: user.bestStreak, lost };

        const grid = document.getElementById('badge-grid');
        grid.innerHTML = '';
        BADGES.forEach(b => {
            const earned = b.check(badgeData);
            const el = document.createElement('div');
            el.className = 'badge' + (earned ? ' earned' : '');
            el.innerHTML = `<span>${b.emoji}</span><span>${b.name}</span>`;
            grid.appendChild(el);
        });

        // Show/hide admin section
        const adminSection = document.getElementById('admin-section');
        if (adminSection) {
            adminSection.style.display = isCurrentUserAdmin() ? 'block' : 'none';
        }
    }

    function editProfile() {
        const user = getUser();
        document.getElementById('start-date').value = user.startDate || '';
        document.getElementById('start-weight').value = user.startWeight || '';
        document.getElementById('goal-weight').value = user.goalWeight || '';
        document.getElementById('target-weeks').value = user.targetWeeks || '';
        showScreen('setup');
        setupPhotoPreview();
    }

    function switchUser() {
        state.currentUser = null;
        saveState();
        updateUserAvatars();
        showScreen('select');
        haptic();
    }

    function editUserName() {
        const currentName = state.currentUser;
        const newName = prompt('Inserisci il nuovo nome per ' + currentName + ':', currentName);

        if (!newName || newName.trim() === '' || newName === currentName) {
            return;
        }

        const trimmedName = newName.trim();

        // Check if name already exists
        if (state.users[trimmedName]) {
            alert('Questo nome esiste giÃ !');
            return;
        }

        // Move user data to new name
        state.users[trimmedName] = state.users[currentName];
        delete state.users[currentName];
        state.currentUser = trimmedName;

        saveState();
        updateUserAvatars();
        renderProfile();
        haptic();
        alert('Nome cambiato in: ' + trimmedName);
    }

    function resetCurrentUser() {
        if (confirm('Sei sicuro di voler cancellare i dati di ' + state.currentUser + '?')) {
            delete state.users[state.currentUser];
            state.currentUser = null;
            saveState();
            updateUserAvatars();
            showScreen('select');
            haptic();
        }
    }

    function resetData() {
        if (confirm('Sei sicuro di voler cancellare TUTTI i dati e ripartire da zero?')) {
            localStorage.removeItem('nunziaDietApp');
            state = { currentUser: null, users: {}, theme: 'light' };
            initDefaultUsers(); // Recreate Paolo (admin) and Flora
            applyTheme();
            renderUserSelection();
            showScreen('select');
            haptic();
        }
    }

    // Test data generator
    function generateTestData() {
        if (!confirm('Genera 4 settimane di dati di test per ' + state.currentUser + '?')) return;

        const user = getUser();
        const today = new Date();
        const startDate = new Date(today);
        startDate.setDate(startDate.getDate() - 28); // 4 weeks ago

        // Set user profile if not set
        if (!user.startDate) {
            user.startDate = formatDate(startDate);
            user.startWeight = isPaolo() ? 85 : 68;
            user.goalWeight = isPaolo() ? 78 : 62;
            user.targetWeeks = 8;
            user.currentWeight = user.startWeight;
        }

        // Reset stats
        user.points = 0;
        user.streak = 0;
        user.bestStreak = 0;
        user.totalDays = 0;
        user.weightHistory = [{ date: user.startDate, weight: user.startWeight }];
        user.days = {};

        const proteine = ['carne', 'pesce', 'crostacei', 'affettato', 'formaggio', 'uova'];
        const carbo = ['pasta', 'riso', 'minestrone'];
        const bevande = ['Te', 'Caffe', 'Camomilla'];
        const accomp = ['Yogurt greco 0,1%', 'PAT'];
        const snack = ['Uovo sodo', 'Bresaola 30g', 'Fesa tacchino 30g', 'Yogurt greco'];
        const verduraTipi = ['Insalata', 'Verdura cotta', 'Insalata + cotta'];

        let currentStreak = 0;
        let weight = user.startWeight;

        for (let i = 0; i < 28; i++) {
            const d = new Date(startDate);
            d.setDate(d.getDate() + i);
            const dateStr = formatDate(d);

            // 85% chance of OK day, 15% sgarro
            const hasSgarro = Math.random() < 0.15;

            const dayData = {
                water: Math.floor(Math.random() * 3) + 2, // 2-4
                activity: Math.random() > 0.4, // 60% chance
                done: true,
                meals: {
                    colazione: {
                        sel: { bevanda: bevande[Math.floor(Math.random() * bevande.length)], accompagnamento: accomp[Math.floor(Math.random() * accomp.length)] },
                        status: hasSgarro && Math.random() < 0.2 ? 'sgarro' : 'ok',
                        note: ''
                    },
                    mezzaMattina: {
                        sel: { proteina: snack[Math.floor(Math.random() * snack.length)] },
                        status: Math.random() < 0.1 ? 'skip' : 'ok',
                        note: ''
                    },
                    pranzo: {
                        sel: {
                            verduraTipo: verduraTipi[Math.floor(Math.random() * verduraTipi.length)],
                            proteina: proteine[Math.floor(Math.random() * proteine.length)],
                            verdureItems: { insalate: ['Lattuga', 'Pomodori'], cotte: ['Broccoli'] }
                        },
                        status: hasSgarro && Math.random() < 0.5 ? 'sgarro' : 'ok',
                        note: ''
                    },
                    pomeriggio: {
                        sel: { bevanda: bevande[Math.floor(Math.random() * bevande.length)], accompagnamento: accomp[Math.floor(Math.random() * accomp.length)] },
                        status: Math.random() < 0.15 ? 'skip' : 'ok',
                        note: ''
                    },
                    cena: {
                        sel: {
                            carbo: carbo[Math.floor(Math.random() * carbo.length)],
                            verduraTipo: verduraTipi[Math.floor(Math.random() * verduraTipi.length)],
                            proteina: proteine[Math.floor(Math.random() * proteine.length)],
                            verdureItems: { insalate: ['Rucola'], cotte: ['Melanzane'] }
                        },
                        status: hasSgarro ? 'sgarro' : 'ok',
                        note: hasSgarro ? 'Pizza con amici' : ''
                    }
                }
            };

            user.days[dateStr] = dayData;
            user.totalDays++;

            // Update streak and points
            const dayHasSgarro = Object.values(dayData.meals).some(m => m.status === 'sgarro');
            if (dayHasSgarro) {
                currentStreak = 0;
            } else {
                currentStreak++;
                let bonus = 10;
                if (dayData.water >= 4) bonus += 5;
                if (dayData.activity) bonus += 5;
                user.points += bonus;
            }
            if (currentStreak > user.bestStreak) user.bestStreak = currentStreak;

            // Update weight (gradual decrease with some variation)
            if (i % 3 === 0 && !dayHasSgarro) {
                weight -= (Math.random() * 0.3 + 0.1); // Lose 0.1-0.4 kg
            } else if (dayHasSgarro) {
                weight += (Math.random() * 0.2); // Gain 0-0.2 kg
            }
            weight = Math.round(weight * 10) / 10;

            // Add weight entry every few days
            if (i % 4 === 0 || i === 27) {
                user.weightHistory.push({ date: dateStr, weight: weight });
            }
        }

        user.streak = currentStreak;
        user.currentWeight = weight;

        // Generate 2 dietologist visits
        user.visits = [];
        const visit1Date = new Date(startDate);
        visit1Date.setDate(visit1Date.getDate() + 7); // 1 week in
        const visit1Weight = user.startWeight - 1.2;
        user.visits.push({
            date: formatDate(visit1Date),
            weight: Math.round(visit1Weight * 10) / 10,
            outcome: 'positive',
            notes: 'Buon inizio, continuare cosi. Aumentare acqua.'
        });
        user.weightHistory.push({ date: formatDate(visit1Date), weight: Math.round(visit1Weight * 10) / 10, isVisit: true });

        const visit2Date = new Date(startDate);
        visit2Date.setDate(visit2Date.getDate() + 21); // 3 weeks in
        const visit2Weight = user.startWeight - 2.8;
        user.visits.push({
            date: formatDate(visit2Date),
            weight: Math.round(visit2Weight * 10) / 10,
            outcome: 'positive',
            notes: 'Ottimi progressi! Mantenere regime attuale.'
        });
        user.weightHistory.push({ date: formatDate(visit2Date), weight: Math.round(visit2Weight * 10) / 10, isVisit: true });

        // Sort weight history by date
        user.weightHistory.sort((a, b) => a.date.localeCompare(b.date));

        saveState();
        viewingDate = new Date();
        updateDayNav();
        initDashboard();
        renderProfile();
        haptic();
        alert('Generati 28 giorni + 2 visite dietologo!');
    }

    // Init
    loadState();
    ensureAdminExists(); // Make sure Paolo is admin
    renderUserSelection();
    updateHeaderUser();
    if (state.currentUser && state.users[state.currentUser] && state.users[state.currentUser].startDate) {
        showScreen('dashboard');
        viewingDate = new Date();
        updateDayNav();
        initDashboard();
    } else if (state.currentUser) {
        showScreen('setup');
        setupPhotoPreview();
    } else {
        showScreen('select');
    }

    // Register service worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }
    </script>
</body>
</html>
